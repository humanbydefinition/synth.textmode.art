(function(w,T){typeof exports=="object"&&typeof module<"u"?T(exports):typeof define=="function"&&define.amd?define(["exports"],T):T((w=typeof globalThis<"u"?globalThis:w||self).textmode={})})(this,function(w){"use strict";var ui=Object.defineProperty;var fi=(w,T,O)=>T in w?ui(w,T,{enumerable:!0,configurable:!0,writable:!0,value:O}):w[T]=O;var a=(w,T,O)=>fi(w,typeof T!="symbol"?T+"":T,O);class T extends Error{constructor(t,e={}){super(T.i(t,e)),this.name="TextmodeError"}static i(t,e){return`${t}${e&&Object.keys(e).length>0?`

ðŸ“‹ Context:${Object.entries(e).map(([i,s])=>`
  - ${i}: ${T.o(s)}`).join("")}`:""}

${"â†“".repeat(24)}
`}static o(t){if(t===null)return"null";if(t===void 0)return"undefined";if(typeof t=="string")return`"${t}"`;if(typeof t=="number"||typeof t=="boolean")return String(t);if(Array.isArray(t))return t.length===0?"[]":t.length<=5?`[${t.map(e=>T.o(e)).join(", ")}]`:`[${t.slice(0,3).map(e=>T.o(e)).join(", ")}, ... +${t.length-3} more]`;if(typeof t=="object"){const e=Object.keys(t);return e.length===0?"{}":e.length<=3?`{ ${e.map(i=>`${i}: ${T.o(t[i])}`).join(", ")} }`:`{ ${e.slice(0,2).map(i=>`${i}: ${T.o(t[i])}`).join(", ")}, ... +${e.length-2} more }`}return String(t)}}var O=(h=>(h[h.SILENT=0]="SILENT",h[h.WARNING=1]="WARNING",h[h.ERROR=2]="ERROR",h[h.THROW=3]="THROW",h))(O||{});const G=class G{constructor(){a(this,"l",{globalLevel:3})}static u(){return G.h||(G.h=new G),G.h}v(t,e){const i="%c[textmode.js] Oops! (â•¯Â°â–¡Â°)â•¯ï¸µ Something went wrong in your code.",s="color: #f44336; font-weight: bold; background: #ffebee; padding: 2px 6px; border-radius: 3px;";switch(this.l.globalLevel){case 0:return!1;case 1:return console.group(i,s),console.warn(T.i(t,e)),console.groupEnd(),!1;case 2:return console.group(i,s),console.error(T.i(t,e)),console.groupEnd(),!1;default:throw new T(t,e)}}m(t,e,i){return!!t||(this.v(e,i),!1)}_(t){this.l.globalLevel=t}};a(G,"h",null);let ut=G;const ft=ut.u();class Y{constructor(t,e,i){a(this,"A");a(this,"M");a(this,"C",new Map);a(this,"U",new Map);a(this,"F",0);a(this,"$",new Map);a(this,"P");this.A=t,this.P=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS)??16,this.M=this.S(e,i),this.R()}R(){const t=this.A.getProgramParameter(this.M,this.A.ACTIVE_UNIFORMS);for(let e=0;e<t;e++){const i=this.A.getActiveUniform(this.M,e);if(i){const s=i.name.replace(/\[0\]$/,""),r=this.A.getUniformLocation(this.M,s);r&&(this.C.set(s,r),this.U.set(s,{type:i.type,size:i.size}))}}}S(t,e){const i=this.k(this.A.VERTEX_SHADER,t),s=this.k(this.A.FRAGMENT_SHADER,e),r=this.A.createProgram();if(this.A.attachShader(r,i),this.A.attachShader(r,s),this.A.linkProgram(r),!this.A.getProgramParameter(r,this.A.LINK_STATUS)){const n=this.A.getProgramInfoLog(r);throw new Error(`Shader program link error: ${n}`)}return this.A.deleteShader(i),this.A.deleteShader(s),r}k(t,e){const i=this.A.createShader(t);if(this.A.shaderSource(i,e),this.A.compileShader(i),!this.A.getShaderParameter(i,this.A.COMPILE_STATUS)){const s=this.A.getShaderInfoLog(i);throw this.A.deleteShader(i),new Error(`Shader compilation error: ${s}`)}return i}D(){this.A.useProgram(this.M),this.L()}L(){this.F=0,this.$.clear()}O(t){for(const e in t)this.H(e,t[e])}H(t,e){var c,l;const i=this.C.get(t);if(!i)return;const s=this.U.get(t);if(!s)return;const{type:r,size:n}=s,o=this.A;if(e instanceof WebGLTexture){const u=this.I(t);return o.uniform1i(i,u),o.activeTexture(o.TEXTURE0+u),void o.bindTexture(o.TEXTURE_2D,e)}if(e instanceof B){const u=this.I(t);return o.uniform1i(i,u),o.activeTexture(o.TEXTURE0+u),void o.bindTexture(o.TEXTURE_2D,e.textures[0])}if(typeof e=="number")return void(r===o.INT||r===o.BOOL?o.uniform1i(i,e):o.uniform1f(i,e));if(typeof e=="boolean")return void o.uniform1i(i,e?1:0);if(Array.isArray(e[0])){const u=e.flat(),f={[o.FLOAT_VEC2]:()=>o.uniform2fv(i,u),[o.FLOAT_VEC3]:()=>o.uniform3fv(i,u),[o.FLOAT_VEC4]:()=>o.uniform4fv(i,u)};(c=f[r])==null||c.call(f)}else{const u=e,f={[o.FLOAT]:()=>n>1?o.uniform1fv(i,u):o.uniform1f(i,u[0]),[o.FLOAT_VEC2]:()=>o.uniform2fv(i,u),[o.FLOAT_VEC3]:()=>o.uniform3fv(i,u),[o.FLOAT_VEC4]:()=>o.uniform4fv(i,u),[o.INT]:()=>n>1?o.uniform1iv(i,u):o.uniform1i(i,u[0]),[o.INT_VEC2]:()=>o.uniform2iv(i,u),[o.INT_VEC3]:()=>o.uniform3iv(i,u),[o.INT_VEC4]:()=>o.uniform4iv(i,u),[o.BOOL]:()=>o.uniform1iv(i,u),[o.FLOAT_MAT2]:()=>o.uniformMatrix2fv(i,!1,u),[o.FLOAT_MAT3]:()=>o.uniformMatrix3fv(i,!1,u),[o.FLOAT_MAT4]:()=>o.uniformMatrix4fv(i,!1,u)};(l=f[r])==null||l.call(f)}}I(t){const e=this.$.get(t);if(e!==void 0)return e;if(this.F>=this.P)throw new Error(`[textmode.js] Shader attempted to bind more than ${this.P} texture samplers. Uniform "${t}" cannot be assigned.`);const i=this.F++;return this.$.set(t,i),i}get program(){return this.M}dispose(){this.A.deleteProgram(this.M)}}function wt(h,t,e,i){return 180*Math.atan2(i-t,e-h)/Math.PI}function W(h,t,e,i){return Math.hypot(e-h,i-t)}function X(h,t,e){return Math.min(Math.max(h,t),e)}function Tt(h){return(h%360+360)%360/360}function Ft(h,t,e){h.bindTexture(h.TEXTURE_2D,t),h.pixelStorei(h.UNPACK_FLIP_Y_WEBGL,1),h.texImage2D(h.TEXTURE_2D,0,h.RGBA,h.RGBA,h.UNSIGNED_BYTE,e),h.bindTexture(h.TEXTURE_2D,null)}function dt(h,t,e,i,s){h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MIN_FILTER,t),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MAG_FILTER,e),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_S,i),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_T,s)}function gt(h,t,e,i,s,r=0,n=WebGL2RenderingContext.FLOAT,o=!1){h.enableVertexAttribArray(t),h.vertexAttribPointer(t,e,n,o,i,s),h.vertexAttribDivisor(t,r)}function Rt(h,t,e,i,s){h.bindBuffer(t,e),h.bufferData(t,i,s),h.bindBuffer(t,null)}const $=`#version 300 es
in vec2 A0;in vec2 A1;in vec2 A2;in vec2 A3;in vec3 A4;in vec4 A5;in vec4 A6;in vec4 A7;in vec3 A8;in vec3 A9;in vec4 Aa;in vec4 Ab;in vec3 Ac;uniform vec2 UG;uniform float UH;uniform float UI;out vec2 v_uv;out vec3 v_glyphIndex;out vec4 v_glyphColor;out vec4 v_cellColor;out vec4 v_glyphFlags;out vec3 v_worldPosition;out vec3 v_normal;out float v_geometryType;const float A=6.28318530718f;const int B=2;const int C=3;const int D=4;vec2 E(float F,vec2 G,vec2 H,vec2 I,vec2 J){float K=1.0f-F;float L=K*K;float M=L*K;float N=F*F;float O=N*F;return M*G+3.0f*L*F*H+3.0f*K*N*I+O*J;}vec2 P(float F,vec2 G,vec2 H,vec2 I,vec2 J){float K=1.0f-F;float L=K*K;float N=F*F;return-3.0f*L*G+3.0f*(L-2.0f*K*F)*H+3.0f*(2.0f*K*F-N)*I+3.0f*N*J;}vec3 Q(vec3 R,float S){float T=cos(S);float U=sin(S);return vec3(R.x,R.y*T-R.z*U,R.y*U+R.z*T);}vec3 V(vec3 R,float S){float T=cos(S);float U=sin(S);return vec3(R.x*T+R.z*U,R.y,-R.x*U+R.z*T);}vec3 W(vec3 R,float S){float T=cos(S);float U=sin(S);return vec3(R.x*T-R.y*U,R.x*U+R.y*T,R.z);}vec3 X(vec3 R,vec3 Y){vec3 Z=R;if(Y.z!=0.0f){Z=W(Z,Y.z);}if(Y.y!=0.0f){Z=V(Z,Y.y);}if(Y.x!=0.0f){Z=Q(Z,Y.x);}return Z;}void main(){v_uv=A1;v_glyphIndex=A4;v_glyphColor=A5;v_cellColor=A6;v_glyphFlags=A7;vec4 a=Aa;vec4 b=Ab;vec2 c=A3;vec2 d=A2;float e=Ac.x;float f=Ac.y;int g=int(Ac.z);vec2 h=d;vec2 i=h+c*0.5f;float j=f+e*0.5f;vec3 k=vec3(i,j);vec3 l;if(g==D){float F=clamp(A0.x,0.0f,1.0f);vec2 G=b.xy;vec2 H=a.xy;vec2 I=a.zw;vec2 J=b.zw;vec2 m=E(F,G,H,I,J);vec2 n=P(F,G,H,I,J);float o=length(n);vec2 p=o>0.0f?n/o:vec2(1.0f,0.0f);vec2 q=vec2(-p.y,p.x);vec2 r=m;vec2 s=r+q*A0.y*c.y;l=vec3(s,f);}else if(g==C){float t=mod(a.x,A);if(t<0.0f){t+=A;}float u=mod(a.y,A);if(u<0.0f){u+=A;}float v=t-u;if(v<=0.0f){v+=A;}float S=t-A0.x*v;vec2 w=vec2(cos(S),sin(S))*A0.y;vec2 s=w*c+h;l=vec3(s,f);}else if(g==B){vec2 s=A0.xy*c+h;l=vec3(s,f);}vec3 x=X(l,A9);vec3 y=x+A8;vec3 z=vec3(0.0f,0.0f,1.0f);v_worldPosition=y;v_normal=z;v_geometryType=float(g);vec2 AA=(y.xy/UG)*2.0f;AA.y=-AA.y;float AB=y.z/UG.y;float AC=clamp(-AB*UH,-0.99f,0.99f);if(UI>0.5f){gl_Position=vec4(AA,AC,1.0f);}else{float AD=0.5f;float AE=1.0f/(1.0f-AB*AD);AA*=AE;gl_Position=vec4(AA,AC,1.0f);}}`,k=class k{constructor(t,e,i=e,s=1,r={},n){a(this,"N");a(this,"G");a(this,"l");a(this,"A");a(this,"j");a(this,"Y",[]);a(this,"X",null);a(this,"W");a(this,"K");a(this,"Z",null);a(this,"q",new Map);this.N=e,this.G=i,this.A=t,this.W=X(s,1,8),this.K=n,this.l={filter:"nearest",wrap:"clamp",format:"rgba",type:"unsigned_byte",depth:!0,...r},k.V||(k.V=new Y(t,$,`#version 300 es
precision highp float;in vec2 v_uv;uniform sampler2D U0;uniform sampler2D U1;uniform sampler2D U2;uniform sampler2D U3;uniform vec2 U4;uniform bool U5;uniform bool U6;uniform bool U7;layout(location=0)out vec4 o_character;layout(location=1)out vec4 o_primaryColor;layout(location=2)out vec4 o_secondaryColor;layout(location=3)out vec4 A;void main(){vec2 B=vec2(v_uv.x,1.-v_uv.y);vec2 C=B*U4;vec2 D=(floor(C)+0.5f)/U4;vec4 E=texture(U0,D);vec4 F=U5?texture(U1,D):vec4(0.);if(U5&&F.a==0.){discard;}vec4 G=U6?texture(U2,D):vec4(0.);vec4 H=U7?texture(U3,D):vec4(0.);o_character=E;o_primaryColor=F;o_secondaryColor=G;A=H;}`));const o=t.getParameter(t.MAX_DRAW_BUFFERS),c=t.getParameter(t.MAX_COLOR_ATTACHMENTS);this.W=Math.min(this.W,o,c),this.j=t.createFramebuffer(),this.J(),this.tt(),this.l.depth&&this.st()}J(){const t=this.A,e=this.l.filter==="linear"?t.LINEAR:t.NEAREST,i=this.l.wrap==="repeat"?t.REPEAT:t.CLAMP_TO_EDGE,s=this.l.type==="float"?t.FLOAT:t.UNSIGNED_BYTE,r=s===t.FLOAT?t.RGBA32F:t.RGBA8,n=t.RGBA;for(let o=0;o<this.W;o++){const c=t.createTexture();t.bindTexture(t.TEXTURE_2D,c),dt(t,e,e,i,i),t.texImage2D(t.TEXTURE_2D,0,r,this.N,this.G,0,n,s,null),this.Y.push(c)}t.bindTexture(t.TEXTURE_2D,null)}tt(){const t=this.A;if(t.bindFramebuffer(t.FRAMEBUFFER,this.j),this.W===1)t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.Y[0],0);else{const e=[];for(let i=0;i<this.W;i++){const s=t.COLOR_ATTACHMENT0+i;t.framebufferTexture2D(t.FRAMEBUFFER,s,t.TEXTURE_2D,this.Y[i],0),e.push(s)}t.drawBuffers(e)}t.bindFramebuffer(t.FRAMEBUFFER,null)}st(){const t=this.A;this.X=t.createRenderbuffer(),t.bindRenderbuffer(t.RENDERBUFFER,this.X),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT24,this.N,this.G),t.bindFramebuffer(t.FRAMEBUFFER,this.j),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,this.X),t.bindFramebuffer(t.FRAMEBUFFER,null),t.bindRenderbuffer(t.RENDERBUFFER,null)}et(t){Ft(this.A,this.Y[0],t)}resize(t,e){this.N=t,this.G=e,this.q.clear();const i=this.A,s=this.l.type==="float"?i.FLOAT:i.UNSIGNED_BYTE,r=s===i.FLOAT?i.RGBA32F:i.RGBA8,n=i.RGBA;for(const o of this.Y)i.bindTexture(i.TEXTURE_2D,o),i.texImage2D(i.TEXTURE_2D,0,r,this.N,this.G,0,n,s,null);i.bindTexture(i.TEXTURE_2D,null),this.X&&(i.bindRenderbuffer(i.RENDERBUFFER,this.X),i.renderbufferStorage(i.RENDERBUFFER,i.DEPTH_COMPONENT24,this.N,this.G),i.bindRenderbuffer(i.RENDERBUFFER,null))}readPixels(t){const e=this.q.get(t);if(e)return e;const i=this.A,s=this.N,r=this.G,n=new Uint8Array(s*r*4),o=i.getParameter(i.READ_FRAMEBUFFER_BINDING);i.bindFramebuffer(i.READ_FRAMEBUFFER,this.j),i.readBuffer(i.COLOR_ATTACHMENT0+t),i.readPixels(0,0,s,r,i.RGBA,i.UNSIGNED_BYTE,n),i.bindFramebuffer(i.READ_FRAMEBUFFER,o);const c=4*s,l=new Uint8Array(n.length);for(let u=0;u<r;u++){const f=(r-1-u)*c,d=u*c;l.set(n.subarray(f,f+c),d)}return this.q.set(t,l),l}begin(){const t=this.A;this.q.clear(),this.K.it(),this.K.rt(this.j,this.N,this.G,this.W),this.l.depth&&t.clear(t.DEPTH_BUFFER_BIT),this.K.state.nt()}end(){this.K.state.ot(),this.K.ht(),this.K.ct()}lt(){return this.Z||this.ut(),this.Z}ut(){if(!this.K)return;const t=this.W>1,e=this.W>2,i=this.W>3,s={U0:this.Y[0],U1:t?this.Y[1]:this.Y[0],U2:e?this.Y[2]:this.Y[0],U3:i?this.Y[3]:this.Y[0],U4:[this.N,this.G],U5:t,U6:e,U7:i},r=k.V;this.Z=this.K.dt.ft(r,s,!0)}dispose(){const t=this.A;t.deleteFramebuffer(this.j),this.Y.forEach(e=>{t.deleteTexture(e)}),this.X&&t.deleteRenderbuffer(this.X)}get width(){return this.N}get height(){return this.G}get textures(){return this.Y}get attachmentCount(){return this.W}};a(k,"V",null);let B=k;const Mt=new WeakMap;function vt(h,t){Mt.set(h,t)}function Ut(h){return Mt.get(h)}function tt(h,t,e,i,s=255){h[0]=t/255,h[1]=(e??t)/255,h[2]=(i??t)/255,h[3]=s/255}class et{constructor(){a(this,"vt",1);a(this,"gt",0);a(this,"_t",0);a(this,"yt",0);a(this,"At",0);a(this,"bt",0);a(this,"wt",0);a(this,"xt",[0,0,0]);a(this,"Mt",[1,1,1,1]);a(this,"Ct",[0,0,0,1]);a(this,"Ft",!1);a(this,"$t",!1);a(this,"Pt",!1);a(this,"Tt",0);a(this,"zt",[0,0,0,1]);a(this,"St",!1);a(this,"Rt",[]);a(this,"Et",[])}static kt(){return{Dt:1,Lt:0,Ot:0,Ht:0,At:0,bt:0,wt:0,Tt:0,Bt:!1,It:!1,Pt:!1,St:!1,Nt:[0,0,0],Gt:[1,1,1,1],jt:[0,0,0,1]}}Qt(t){t.Dt=this.vt,t.Lt=this.gt,t.Ot=this._t,t.Ht=this.yt,t.At=this.At,t.bt=this.bt,t.wt=this.wt,t.Bt=this.Ft,t.It=this.$t,t.Pt=this.Pt,t.Tt=this.Tt,t.St=this.St,t.Nt[0]=this.xt[0],t.Nt[1]=this.xt[1],t.Nt[2]=this.xt[2],t.Gt[0]=this.Mt[0],t.Gt[1]=this.Mt[1],t.Gt[2]=this.Mt[2],t.Gt[3]=this.Mt[3],t.jt[0]=this.Ct[0],t.jt[1]=this.Ct[1],t.jt[2]=this.Ct[2],t.jt[3]=this.Ct[3]}Yt(t){this.vt=t.Dt,this.gt=t.Lt,this._t=t.Ot,this.yt=t.Ht,this.At=t.At,this.bt=t.bt,this.wt=t.wt,this.Ft=t.Bt,this.$t=t.It,this.Pt=t.Pt,this.Tt=t.Tt,this.St=t.St,this.xt[0]=t.Nt[0],this.xt[1]=t.Nt[1],this.xt[2]=t.Nt[2],this.Mt[0]=t.Gt[0],this.Mt[1]=t.Gt[1],this.Mt[2]=t.Gt[2],this.Mt[3]=t.Gt[3],this.Ct[0]=t.jt[0],this.Ct[1]=t.jt[1],this.Ct[2]=t.jt[2],this.Ct[3]=t.jt[3]}nt(){let t=this.Et.pop();t||(t=et.kt()),this.Qt(t),this.Rt.push(t)}ot(){const t=this.Rt.pop();t?(this.Yt(t),this.Et.push(t)):console.warn("pop() called without matching push()")}Xt(t){this.Qt(t)}Wt(t){this.vt=Math.abs(t)}Kt(){this.gt=0,this._t=0,this.yt=0,this.At=0,this.bt=0,this.wt=0,this.St=!1}Zt(t){t!==0&&(this.At+=t*Math.PI/180)}qt(t){t!==0&&(this.bt+=t*Math.PI/180)}Vt(t){t!==0&&(this.wt+=t*Math.PI/180)}Jt(t=0,e=0,i=0){t===0&&e===0&&i===0||(this.gt+=t,this._t+=e,this.yt+=i)}ts(t){this.Jt(t,0,0)}ss(t){this.Jt(0,t,0)}es(t){this.Jt(0,0,t)}rs(t){this.xt[0]=t[0],this.xt[1]=t[1],this.xt[2]=t[2]}ns(t,e,i,s=255){tt(this.Mt,t,e,i,s)}hs(t,e,i,s=255){tt(this.Ct,t,e,i,s)}cs(t){this.Ft=t}ls(t){this.$t=t}us(t){this.Pt=t}fs(t){this.Tt=Tt(t)}ds(t,e,i,s){tt(this.zt,t,e,i,s)}vs(t){this.St=t}get canvasBackgroundColor(){return this.zt}get useOrtho(){return this.St}get rotationX(){return this.At}get rotationY(){return this.bt}get rotationZ(){return this.wt}}const mt=new Float32Array([-.5,-.5,0,0,.5,-.5,1,0,-.5,.5,0,1,-.5,.5,0,1,.5,-.5,1,0,.5,.5,1,1]),K={ps:16,gs:WebGL2RenderingContext.TRIANGLES,_s:{As:{size:2,offset:0},bs:{size:2,offset:8}}};class oe{constructor(t){a(this,"A");a(this,"ws");a(this,"Ms");this.A=t,this.ws=t.createBuffer(),this.Ms=new Float32Array(mt.length)}Cs(t,e,i,s){const r=this.A,n=Ut(this.A),o=n[2],c=n[3],l=t/o*2-1,u=(t+i)/o*2-1,f=1-(e+s)/c*2,d=1-e/c*2,g=mt,v=this.Ms;for(let A=0;A<g.length;A+=4){const m=g[A],b=g[A+1],p=g[A+2],y=g[A+3],x=l+(m+.5)*(u-l),E=f+(b+.5)*(d-f);v[A]=x,v[A+1]=E,v[A+2]=p,v[A+3]=y}r.bindBuffer(r.ARRAY_BUFFER,this.ws),r.bufferData(r.ARRAY_BUFFER,v,r.DYNAMIC_DRAW),r.enableVertexAttribArray(0),r.vertexAttribPointer(0,2,r.FLOAT,!1,16,0),r.enableVertexAttribArray(1),r.vertexAttribPointer(1,2,r.FLOAT,!1,16,8),r.drawArrays(r.TRIANGLES,0,6),r.disableVertexAttribArray(1),r.disableVertexAttribArray(0),r.bindBuffer(r.ARRAY_BUFFER,null)}Fs(){this.A.deleteBuffer(this.ws)}}var U=(h=>(h.RECTANGLE="rectangle",h.LINE="line",h.ELLIPSE="ellipse",h.ARC="arc",h.TRIANGLE="triangle",h.BEZIER_CURVE="bezier_curve",h))(U||{});const he={rectangle:2,line:2,ellipse:2,triangle:2,arc:3,bezier_curve:4};class ae{constructor(t){a(this,"A");a(this,"$s",new Map);this.A=t}Ps(t,e,i,s){const r=this.A;let n=this.$s.get(t);n||(n=new Map,this.$s.set(t,n));let o=n.get(e)||null;if(!o){o=r.createVertexArray(),n.set(e,o),r.bindVertexArray(o),r.bindBuffer(r.ARRAY_BUFFER,s);const c=r.getAttribLocation(t,"A0");c!==-1&&gt(r,c,i._s.As.size,i.ps,i._s.As.offset,0,r.FLOAT,!1);const l=r.getAttribLocation(t,"A1");l!==-1&&gt(r,l,i._s.bs.size,i.ps,i._s.bs.offset,0,r.FLOAT,!1)}r.bindVertexArray(o)}Ts(){this.A.bindVertexArray(null)}Fs(){for(const[,t]of this.$s)for(const[,e]of t)e&&this.A.deleteVertexArray(e)}}const z=class z{static zs(t,e,i=0){const s=e||new Float32Array(z.FLOATS_PER_INSTANCE);let r=i;s[r++]=t.As[0],s[r++]=t.As[1],s[r++]=t.Ss[0],s[r++]=t.Ss[1],s[r++]=t.Nt[0],s[r++]=t.Nt[1],s[r++]=t.Nt[2],s[r++]=t.Gt[0],s[r++]=t.Gt[1],s[r++]=t.Gt[2],s[r++]=t.Gt[3],s[r++]=t.jt[0],s[r++]=t.jt[1],s[r++]=t.jt[2],s[r++]=t.jt[3],s[r++]=t.Rs[0],s[r++]=t.Rs[1],s[r++]=t.Rs[2],s[r++]=t.Tt;const n=t.Es;s[r++]=(n==null?void 0:n[0])??0,s[r++]=(n==null?void 0:n[1])??0,s[r++]=(n==null?void 0:n[2])??0;const o=t.ks;s[r++]=(o==null?void 0:o[0])??0,s[r++]=(o==null?void 0:o[1])??0,s[r++]=(o==null?void 0:o[2])??0;const c=t.Ds,l=t.Ls,u=t.Os,f=t.Hs,d=t.Bs,g=!(!l||!u);return g?(s[r++]=(f==null?void 0:f[0])??0,s[r++]=(f==null?void 0:f[1])??0,s[r++]=(d==null?void 0:d[0])??0,s[r++]=(d==null?void 0:d[1])??0,s[r++]=l[0],s[r++]=l[1],s[r++]=u[0],s[r++]=u[1]):!g&&!!c?(s[r++]=c[0],s[r++]=c[1],s[r++]=0,s[r++]=0,s[r++]=0,s[r++]=0,s[r++]=0,s[r++]=0):(s[r++]=0,s[r++]=0,s[r++]=0,s[r++]=0,s[r++]=0,s[r++]=0,s[r++]=0,s[r++]=0),s[r++]=t.Is??0,s[r++]=t.Ns??0,s[r++]=t.Gs??0,s}static js(t,e){const i=t.length*z.FLOATS_PER_INSTANCE,s=e||new Float32Array(i);for(let r=0;r<t.length;r++){const n=r*z.FLOATS_PER_INSTANCE;z.zs(t[r],s,n)}return s}};a(z,"BYTES_PER_INSTANCE",144),a(z,"FLOATS_PER_INSTANCE",36);let S=z;const N=class N{};a(N,"STRIDE",S.BYTES_PER_INSTANCE),a(N,"ATTRIBUTES",{A2:{location:-1,size:2,type:WebGL2RenderingContext.FLOAT,normalized:!1,stride:N.STRIDE,offset:0,divisor:1},A3:{location:-1,size:2,type:WebGL2RenderingContext.FLOAT,normalized:!1,stride:N.STRIDE,offset:8,divisor:1},A4:{location:-1,size:3,type:WebGL2RenderingContext.FLOAT,normalized:!1,stride:N.STRIDE,offset:16,divisor:1},A5:{location:-1,size:4,type:WebGL2RenderingContext.FLOAT,normalized:!1,stride:N.STRIDE,offset:28,divisor:1},A6:{location:-1,size:4,type:WebGL2RenderingContext.FLOAT,normalized:!1,stride:N.STRIDE,offset:44,divisor:1},A7:{location:-1,size:4,type:WebGL2RenderingContext.FLOAT,normalized:!1,stride:N.STRIDE,offset:60,divisor:1},A8:{location:-1,size:3,type:WebGL2RenderingContext.FLOAT,normalized:!1,stride:N.STRIDE,offset:76,divisor:1},A9:{location:-1,size:3,type:WebGL2RenderingContext.FLOAT,normalized:!1,stride:N.STRIDE,offset:88,divisor:1},Aa:{location:-1,size:4,type:WebGL2RenderingContext.FLOAT,normalized:!1,stride:N.STRIDE,offset:100,divisor:1},Ab:{location:-1,size:4,type:WebGL2RenderingContext.FLOAT,normalized:!1,stride:N.STRIDE,offset:116,divisor:1},Ac:{location:-1,size:3,type:WebGL2RenderingContext.FLOAT,normalized:!1,stride:N.STRIDE,offset:132,divisor:1}});let Q=N;class ce{constructor(t=1e3,e=1.5){a(this,"Qs");a(this,"Ys");a(this,"Xs");a(this,"Ws",0);a(this,"Ks",0);this.Ys=t,this.Xs=e;const i=t*S.FLOATS_PER_INSTANCE;this.Qs=new Float32Array(i)}Zs(t){if(t<=this.Ys)return;const e=Math.ceil(t*this.Xs),i=this.Ys;this.Ys=e;const s=e*S.FLOATS_PER_INSTANCE,r=new Float32Array(s),n=i*S.FLOATS_PER_INSTANCE;r.set(this.Qs.subarray(0,Math.min(n,this.Ws))),this.Qs=r}qs(){return{buffer:this.Qs,offset:this.Ws}}Vs(t){this.Ws+=t,this.Ks++}Js(){this.Ws=0,this.Ks=0}te(t=0,e){return this.Qs.subarray(t,e??this.Ws)}get se(){return this.Ks}get ee(){return this.Ys}get ie(){return this.Ws}get re(){return this.Ks===0}}class le{constructor(t){a(this,"Qs");this.Qs=t}ne(t){this.Qs.Zs(this.Qs.se+1);const{buffer:e,offset:i}=this.Qs.qs();e[i+0]=t.x,e[i+1]=t.y,e[i+2]=t.width,e[i+3]=t.height,e[i+4]=t.char0,e[i+5]=t.char1,e[i+6]=t.char2,e[i+7]=t.r1,e[i+8]=t.g1,e[i+9]=t.b1,e[i+10]=t.a1,e[i+11]=t.r2,e[i+12]=t.g2,e[i+13]=t.b2,e[i+14]=t.a2,e[i+15]=t.invert,e[i+16]=t.flipX,e[i+17]=t.flipY,e[i+18]=t.charRot,e[i+19]=t.translationX,e[i+20]=t.translationY,e[i+21]=t.translationZ,e[i+22]=t.rotationX,e[i+23]=t.rotationY,e[i+24]=t.rotationZ;const s=t.curveParams0,r=t.curveParams1;return e[i+25]=s[0],e[i+26]=s[1],e[i+27]=s[2],e[i+28]=s[3],e[i+29]=r[0],e[i+30]=r[1],e[i+31]=r[2],e[i+32]=r[3],e[i+33]=t.depth,e[i+34]=t.baseZ,e[i+35]=t.geometryType,this.Qs.Vs(S.FLOATS_PER_INSTANCE),this.Qs.se-1}get se(){return this.Qs.se}}class ue{constructor(t,e=1e3){a(this,"A");a(this,"oe",null);a(this,"he",0);a(this,"ae",new Map);this.A=t,this.ce(e)}ce(t){const e=this.A;this.oe&&e.deleteBuffer(this.oe),this.oe=e.createBuffer();const i=t*S.BYTES_PER_INSTANCE;Rt(e,e.ARRAY_BUFFER,this.oe,i,e.DYNAMIC_DRAW),this.he=t}le(t){this.ce(t)}get ee(){return this.he}ue(t,e){if(e===0)return;const i=this.A;i.bindBuffer(i.ARRAY_BUFFER,this.oe);const s=e*S.FLOATS_PER_INSTANCE;i.bufferSubData(i.ARRAY_BUFFER,0,t,0,s)}fe(t){let e=this.ae.get(t);if(!e){e=new Map;const i=this.A;for(const s in Q.ATTRIBUTES){const r=i.getAttribLocation(t,s);r!==-1&&e.set(s,r)}this.ae.set(t,e)}return e}de(t){const e=this.A,i=t.program,s=this.fe(i);for(const[r,n]of s){const o=Q.ATTRIBUTES[r];o&&gt(e,n,o.size,o.stride,o.offset,o.divisor,o.type,o.normalized)}}ve(t){const e=this.A,i=this.fe(t.program);for(const[s,r]of i)Q.ATTRIBUTES[s]&&(e.disableVertexAttribArray(r),e.vertexAttribDivisor(r,0))}Fs(){this.oe&&(this.A.deleteBuffer(this.oe),this.oe=null),this.ae.clear()}}class fe{constructor(t,e=1e3,i=1.5){a(this,"A");a(this,"Qs");a(this,"pe");a(this,"me");this.A=t,this.Qs=new ce(e,i),this.pe=new le(this.Qs),this.me=new ue(t,e)}ge(t){var s,r,n,o,c,l,u,f,d,g;const e=[0,0,0,0],i=[0,0,0,0];return t.Ls&&t.Os?(e[0]=((s=t.Hs)==null?void 0:s[0])??0,e[1]=((r=t.Hs)==null?void 0:r[1])??0,e[2]=((n=t.Bs)==null?void 0:n[0])??0,e[3]=((o=t.Bs)==null?void 0:o[1])??0,i[0]=t.Ls[0],i[1]=t.Ls[1],i[2]=t.Os[0],i[3]=t.Os[1]):t.Ds&&(e[0]=t.Ds[0],e[1]=t.Ds[1]),this.ne({x:t.As[0],y:t.As[1],width:t.Ss[0],height:t.Ss[1],char0:t.Nt[0],char1:t.Nt[1],char2:t.Nt[2],r1:t.Gt[0],g1:t.Gt[1],b1:t.Gt[2],a1:t.Gt[3],r2:t.jt[0],g2:t.jt[1],b2:t.jt[2],a2:t.jt[3],invert:t.Rs[0],flipX:t.Rs[1],flipY:t.Rs[2],charRot:t.Tt,translationX:((c=t.Es)==null?void 0:c[0])??0,translationY:((l=t.Es)==null?void 0:l[1])??0,translationZ:((u=t.Es)==null?void 0:u[2])??0,rotationX:((f=t.ks)==null?void 0:f[0])??0,rotationY:((d=t.ks)==null?void 0:d[1])??0,rotationZ:((g=t.ks)==null?void 0:g[2])??0,curveParams0:e,curveParams1:i,depth:t.Is||0,baseZ:t.Ns||0,geometryType:t.Gs||0})}ne(t){const e=this.pe.ne(t);return this.Qs.ee>this.me.ee&&this.me.le(this.Qs.ee),e}get _e(){return this.Qs.se}get re(){return this.Qs.re}ye(){this.Qs.Js()}de(t){const e=this.Qs.se;if(e===0)return;const i=this.Qs.te();this.me.ue(i,e),this.me.de(t)}ve(t){this.me.ve(t)}Cs(t,e){const i=this.Qs.se;i!==0&&this.A.drawArraysInstanced(t,0,e,i)}Fs(){this.me.Fs()}}class H{constructor(t,e,i,s){a(this,"A");a(this,"Ae");a(this,"be");a(this,"we");a(this,"xe",null);this.A=t,this.Ae=e,this.be=i,this.we=s;const r=this.A.createBuffer();Rt(this.A,this.A.ARRAY_BUFFER,r,this.we.Me,this.A.STATIC_DRAW),this.xe=r}get type(){return this.be}get unitGeometry(){return this.we}get unitBuffer(){return this.xe}get batch(){return this.Ae}Ce(){this.Ae.ye()}Fe(){return!this.Ae.re}Fs(){this.Ae.Fs(),this.A.deleteBuffer(this.xe)}$e(t,e,i){return this.Ae.ge(t)}Pe(t,e,i,s,r,n){const o=r.Lt??0,c=r.Ot??0,l=r.Ht??0,u=r.At??0,f=r.bt??0,d=r.wt??0,g=[0,0,0,0],v=[0,0,0,0];n&&(n.bezStartX!==void 0&&n.bezStartY!==void 0&&n.bezEndX!==void 0&&n.bezEndY!==void 0?(g[0]=n.cp1x??0,g[1]=n.cp1y??0,g[2]=n.cp2x??0,g[3]=n.cp2y??0,v[0]=n.bezStartX??0,v[1]=n.bezStartY??0,v[2]=n.bezEndX??0,v[3]=n.bezEndY??0):n.arcStart===void 0&&n.arcStop===void 0||(g[0]=n.arcStart??0,g[1]=n.arcStop??0));const A={x:t,y:e,width:i,height:s,char0:r.Nt[0],char1:r.Nt[1],char2:r.Nt[2],r1:r.Gt[0],g1:r.Gt[1],b1:r.Gt[2],a1:r.Gt[3],r2:r.jt[0],g2:r.jt[1],b2:r.jt[2],a2:r.jt[3],invert:r.Pt?1:0,flipX:r.Bt?1:0,flipY:r.It?1:0,charRot:r.Tt,translationX:o,translationY:c,translationZ:l,rotationX:u,rotationY:f,rotationZ:d,curveParams0:g,curveParams1:v,depth:(n==null?void 0:n.depth)??0,baseZ:(n==null?void 0:n.baseZ)??0,geometryType:he[this.be]??0};return this.Ae.ne(A)}}const de={Me:mt,Te:6,...K},ge={Me:new Float32Array([0,-.5,0,0,1,-.5,1,0,0,.5,0,1,0,.5,0,1,1,-.5,1,0,1,.5,1,1]),Te:6,...K},ve={Me:function(h=32){const t=[],e=2*Math.PI/h;for(let i=0;i<h;i++){const s=i*e,r=(i+1)%h*e,n=Math.cos(s),o=Math.sin(s),c=.5*(n+1),l=.5*(o+1),u=Math.cos(r),f=Math.sin(r),d=.5*(u+1),g=.5*(f+1);t.push(0,0,.5,.5,n,o,c,l,u,f,d,g)}return new Float32Array(t)}(32),Te:96,...K};let me={Me:function(h){const t=[];for(let e=0;e<h;e++){const i=e/h,s=(e+1)/h;t.push(i,0,i,0,i,1,i,1,s,1,s,1)}return new Float32Array(t)}(32),Te:96,...K};const Ae={Me:new Float32Array([0,0,0,0,1,0,1,0,.5,1,.5,1]),Te:3,...K},pe={Me:function(h=16){const t=[];for(let e=0;e<h;e++){const i=e/h,s=(e+1)/h;t.push(i,-.5,i,0,s,-.5,s,0,i,.5,i,1,i,.5,i,1,s,-.5,s,0,s,.5,s,1)}return new Float32Array(t)}(16),Te:96,...K},ye={[U.RECTANGLE]:class extends H{constructor(h,t){super(h,t,U.RECTANGLE,de)}ge(h,t){return this.Pe(0,0,h.width,h.height,t)}},[U.LINE]:class extends H{constructor(h,t){super(h,t,U.LINE,ge)}ge(h,t){const e=h.x2-h.x1,i=h.y2-h.y1,s=Math.hypot(e,i),r=Math.atan2(i,e),n=t.Dt||1,o=h.x1+e/2-s/2,c=h.y1+i/2,l={...t,wt:(t.wt||0)+r};return this.Pe(o,c,s,n,l)}},[U.ELLIPSE]:class extends H{constructor(h,t){super(h,t,U.ELLIPSE,ve)}ge(h,t){return this.Pe(0,0,h.width,h.height,t)}},[U.ARC]:class extends H{constructor(h,t){super(h,t,U.ARC,me)}ge(h,t){const e=h.start*Math.PI/180,i=h.stop*Math.PI/180;return this.Pe(0,0,h.width,h.height,t,{arcStart:e,arcStop:i})}},[U.TRIANGLE]:class extends H{constructor(h,t){super(h,t,U.TRIANGLE,Ae)}ge(h,t){const e=Math.min(h.x1,h.x2,h.x3),i=Math.max(h.x1,h.x2,h.x3),s=Math.min(h.y1,h.y2,h.y3),r=i-e,n=Math.max(h.y1,h.y2,h.y3)-s;return this.Pe(e,s,r,n,t)}},[U.BEZIER_CURVE]:class extends H{constructor(h,t){super(h,t,U.BEZIER_CURVE,pe)}ge(h,t){return this.Pe(0,0,1,t.Dt||1,t,{cp1x:h.cp1x,cp1y:h.cp1y,cp2x:h.cp2x,cp2y:h.cp2y,bezStartX:h.x1,bezStartY:h.y1,bezEndX:h.x2,bezEndY:h.y2})}}};class Ee{constructor(t){a(this,"A");a(this,"ze");a(this,"Se");this.A=t,this.Se=new ae(t),this.ze=new Map;for(const e of Object.values(U)){const i=new fe(t),s=new ye[e](t,i);this.ze.set(e,s)}}Re(t){this.Ee(t).forEach(e=>{this.ke(e)})}Ee(t){const e=[];let i=null,s=null,r=null;for(const n of t)s!==n.material||r!==n.type?(i&&i.length>0&&e.push({material:s,type:r,commands:i}),i=[n],s=n.material,r=n.type):i.push(n);return i&&i.length>0&&e.push({material:s,type:r,commands:i}),e}ke(t){const{material:e,type:i,commands:s}=t,r=this.ze.get(i);e.shader.D(),e.shader.O(e.uniforms);const n=Ut(this.A),o=s.length>0&&s[0].state.St;if(e.shader.O({UJ:n[2]/n[3],UG:[n[2],n[3]],UH:1,UI:o?1:0}),r.Ce(),s.forEach(c=>{r.ge(c.params,c.state)}),r.Fe()){const c=r.unitGeometry,l=r.unitBuffer;try{this.Se.Ps(e.shader.program,String(i),c,l),r.batch.de(e.shader),r.batch.Cs(c.gs,c.Te)}finally{r.batch.ve(e.shader),this.Se.Ts(),r.Ce()}}}Fs(){for(const t of this.ze.values())t.Fs();this.ze.clear(),this.Se.Fs()}}function Pt(h){let t=0;for(let e=0;e<h.length;e++)t=(t<<5)-t+h.charCodeAt(e),t&=t;return t}const Ct=new WeakMap;let be=1;function Nt(h){if(h==null)return 0;if(typeof h!="object"&&typeof h!="function")return Pt(String(h));let t=Ct.get(h);return t||(t=be++,Ct.set(h,t)),t}function V(h,t){return(h<<5)-h+t}class xe{constructor(t){a(this,"De",0);a(this,"Le");a(this,"Oe");a(this,"He",new Map);this.Le=new Y(t,$,`#version 300 es
precision highp float;in vec3 v_glyphIndex;in vec4 v_glyphColor;in vec4 v_cellColor;in vec4 v_glyphFlags;layout(location=0)out vec4 o_character;layout(location=1)out vec4 o_primaryColor;layout(location=2)out vec4 o_secondaryColor;layout(location=3)out vec4 A;void main(){int B=int(v_glyphFlags.r>0.5?1:0);int C=int(v_glyphFlags.g>0.5?1:0);int D=int(v_glyphFlags.b>0.5?1:0);float E=float(B|(C<<1)|(D<<2))/255.;o_character=vec4(v_glyphIndex.xy,E,clamp(v_glyphFlags.a,0.,1.));o_primaryColor=vec4(v_glyphColor.rgb,v_glyphColor.a);o_secondaryColor=vec4(v_cellColor.rgb,v_cellColor.a);A=vec4(0.);}`),this.Oe={id:this.De++,shader:this.Le,uniforms:Object.freeze({}),hash:this.Be(this.Le,{}),isBuiltIn:!0}}get Ie(){return this.Oe}ft(t,e={},i=!1){const s=this.Be(t,e),r=this.He.get(s);if(r)return r;const n={id:this.De++,shader:t,uniforms:Object.freeze({...e}),hash:s,isBuiltIn:i};return this.He.set(s,n),n}Ne(t,e={}){return{id:this.De++,shader:t,uniforms:Object.freeze({...e}),hash:0,isBuiltIn:!1}}Be(t,e){const i=Nt(t.program),s=function(r,n){let o=0;const c=Object.keys(r).sort();for(const l of c)o=V(o,Pt(l)),o=V(o,n(r[l]));return o}(e,this.Ge.bind(this));return V(i,s)}Ge(t){return typeof t=="number"||typeof t=="boolean"?function(e){return typeof e=="boolean"?e?1:0:Math.floor(e)}(t):Array.isArray(t)?function(e){let i=0;const s=Array.isArray(e[0])?e.flat():e;for(const r of s)i=V(i,typeof r=="number"?r:0);return i}(t):t instanceof Float32Array||t instanceof Int32Array?function(e){let i=0;const s=Math.min(e.length,16);for(let r=0;r<s;r++)i=V(i,e[r]);return i}(t):t instanceof WebGLTexture?Nt(t):0}Fs(){this.Le!=this.Le&&this.Le.dispose(),this.Le.dispose(),this.He.clear()}}class we{constructor(){a(this,"je",[]);a(this,"Qe",1);a(this,"Ss",0)}Ye(t,e){if(this.Ss>=this.je.length){const s={id:this.Qe++,type:t,params:{},state:et.kt(),material:e};this.je.push(s)}const i=this.je[this.Ss];return i.id=this.Qe++,i.type=t,i.material=e,this.Ss++,i}Xe(t,e,i){const s=this.Ye(U.RECTANGLE,i),r=s.params;return r.width=t.width,r.height=t.height,e.Xt(s.state),s.id}We(t,e,i){const s=this.Ye(U.LINE,i),r=s.params;return r.x1=t.x1,r.y1=t.y1,r.x2=t.x2,r.y2=t.y2,r.thickness=t.thickness,e.Xt(s.state),s.id}Ke(t,e,i){const s=this.Ye(U.ELLIPSE,i),r=s.params;return r.width=t.width,r.height=t.height,r.startAngle=t.startAngle,r.endAngle=t.endAngle,r.segments=t.segments,e.Xt(s.state),s.id}Ze(t,e,i){const s=this.Ye(U.ARC,i),r=s.params;return r.width=t.width,r.height=t.height,r.start=t.start,r.stop=t.stop,e.Xt(s.state),s.id}qe(t,e,i){const s=this.Ye(U.TRIANGLE,i),r=s.params;return r.x1=t.x1,r.y1=t.y1,r.x2=t.x2,r.y2=t.y2,r.x3=t.x3,r.y3=t.y3,e.Xt(s.state),s.id}Ve(t,e,i){const s=this.Ye(U.BEZIER_CURVE,i),r=s.params;return r.x1=t.x1,r.y1=t.y1,r.cp1x=t.cp1x,r.cp1y=t.cp1y,r.cp2x=t.cp2x,r.cp2y=t.cp2y,r.x2=t.x2,r.y2=t.y2,r.thickness=t.thickness,r.segments=t.segments,e.Xt(s.state),s.id}ye(){this.Ss=0}[Symbol.iterator](){let t=0;const e=this.Ss,i=this.je;return{next:()=>t<e?{value:i[t++],done:!1}:{value:void 0,done:!0}}}}class Te{constructor(t){a(this,"A");a(this,"Je",null);a(this,"ti");a(this,"dt");a(this,"si");a(this,"ei");a(this,"ii");a(this,"ri",null);a(this,"ni",{});a(this,"oi",[]);a(this,"hi",[]);a(this,"ai",[]);a(this,"ci",null);a(this,"li",[0,0,0,0]);a(this,"ui",1);this.A=t,t.enable(t.DEPTH_TEST),t.depthFunc(t.LEQUAL),t.clearDepth(1),t.depthMask(!0),t.disable(t.CULL_FACE),this.si=new et,this.dt=new xe(t),this.ei=new we,this.ti=new Ee(t),this.ii=new oe(t);const e=[0,0,t.canvas.width,t.canvas.height];vt(t,e),this.oi.push(null),this.hi.push(e),this.ai.push(1),this.ci=null,this.li=e,this.ui=1}it(){this.oi.push(this.ci),this.hi.push([...this.li]),this.ai.push(this.ui)}ct(){const t=this.oi.pop()??null,e=this.hi.pop()??[0,0,this.A.canvas.width,this.A.canvas.height],i=this.ai.pop()??1;this.rt(t,e[2],e[3],i)}rt(t,e,i,s=1){const r=this.A;this.ci!==t&&(r.bindFramebuffer(r.FRAMEBUFFER,t),this.ci=t),this.ui=s;const n=[0,0,e,i];this.li[0]===n[0]&&this.li[1]===n[1]&&this.li[2]===n[2]&&this.li[3]===n[3]||(r.viewport(...n),vt(r,n),this.li=n)}fi(t){this.Je!==t&&(this.Je=t,t.D())}di(t,e){return new Y(this.A,t,e)}pi(t){this.ri=t,t&&(this.ni={})}H(t,e){this.ni[t]=e}mi(t){Object.assign(this.ni,t)}gi(t){return new Y(this.A,$,t)}_i(t,e,i,s){t instanceof B||!s||t.yi(s),this.ei.Xe({width:e??t.width,height:i??t.height},this.si,t.lt())}Ai(t,e,i,s){this.ii.Cs(t,e,i,s)}bi(t,e){if(this.ri){const i=this.dt.Ne(this.ri,this.ni);this.ei.Xe({width:t,height:e},this.si,i),this.ri=null,this.ni={}}else this.ei.Xe({width:t,height:e},this.si,this.dt.Ie)}wi(t,e,i,s){this.ei.We({x1:t,y1:e,x2:i,y2:s},this.si,this.dt.Ie)}xi(t,e){this.ei.Ke({width:t,height:e},this.si,this.dt.Ie)}Mi(t,e,i,s,r,n){this.ei.qe({x1:t,y1:e,x2:i,y2:s,x3:r,y3:n},this.si,this.dt.Ie)}Ci(t,e,i,s,r,n,o,c){this.ei.Ve({x1:t,y1:e,cp1x:i,cp1y:s,cp2x:r,cp2y:n,x2:o,y2:c},this.si,this.dt.Ie)}Fi(t,e,i,s){this.ei.Ze({width:t,height:e,start:i,stop:s},this.si,this.dt.Ie)}$i(t,e,i=1,s={}){return new B(this.A,t,e,i,s,this)}Pi(t,e=t,i=t,s=255){this.si.ds(t,e??t,i??t,s);const[r,n,o,c]=this.si.canvasBackgroundColor;this.Ti(r,n,o,c,!1)}ye(t=0,e=0,i=0,s=0){this.Ti(t,e,i,s,!0)}Ti(t,e,i,s,r){const n=this.A;if(this.ui>1){const o=r?[1,1,0,0]:[0,0,0,0];n.clearBufferfv(n.COLOR,0,new Float32Array(o)),n.clearBufferfv(n.COLOR,1,new Float32Array([0,0,0,0])),this.ui>=3&&n.clearBufferfv(n.COLOR,2,new Float32Array([t,e,i,s]));for(let c=3;c<this.ui;c++)n.clearBufferfv(n.COLOR,c,new Float32Array([0,0,0,0]))}else n.clearColor(t,e,i,s),n.clear(n.COLOR_BUFFER_BIT)}zi(){const t=[0,0,this.A.canvas.width,this.A.canvas.height];this.A.viewport(...t),vt(this.A,t),this.li=t,this.hi.length>0&&(this.hi[0]=t)}ht(){const t=this.ei;this.ti.Re(t),t.ye(),this.Je=null}Fs(){this.dt.Fs(),this.ti.Fs(),this.ii.Fs()}get context(){return this.A}get state(){return this.si}get materialManager(){return this.dt}}const P={readShort:(h,t)=>(P.t.uint16[0]=h[t]<<8|h[t+1],P.t.int16[0]),readUshort:(h,t)=>h[t]<<8|h[t+1],readUshorts(h,t,e){const i=[];for(let s=0;s<e;s++)i.push(P.readUshort(h,t+2*s));return i},readUint(h,t){const e=P.t.uint8;return e[3]=h[t],e[2]=h[t+1],e[1]=h[t+2],e[0]=h[t+3],P.t.uint32[0]},readASCII(h,t,e){let i="";for(let s=0;s<e;s++)i+=String.fromCharCode(h[t+s]);return i},t:(()=>{const h=new ArrayBuffer(8);return{uint8:new Uint8Array(h),int16:new Int16Array(h),uint16:new Uint16Array(h),uint32:new Uint32Array(h)}})()};function it(h){return h+3&-4}function st(h,t,e){h[t]=e>>>8&255,h[t+1]=255&e}function _(h,t,e){h[t]=e>>>24&255,h[t+1]=e>>>16&255,h[t+2]=e>>>8&255,h[t+3]=255&e}function Fe(h,t,e){for(let i=0;i<e.length;i++)h[t+i]=255&e.charCodeAt(i)}function At(h,t,e){const i=t+e;let s=0;const r=P.t;for(let n=t;n<i;n+=4)r.uint8[3]=h[n]||0,r.uint8[2]=h[n+1]||0,r.uint8[1]=h[n+2]||0,r.uint8[0]=h[n+3]||0,s=s+(r.uint32[0]>>>0)>>>0;return s>>>0}class Re{constructor(t){a(this,"b");a(this,"p",0);a(this,"bitbuf",0);a(this,"bitcnt",0);this.b=t}readBits(t){for(;this.bitcnt<t;){const i=this.b[this.p++]||0;this.bitbuf|=i<<this.bitcnt,this.bitcnt+=8}const e=this.bitbuf&(1<<t)-1;return this.bitbuf>>>=t,this.bitcnt-=t,e}alignToByte(){this.bitbuf=0,this.bitcnt=0}get offset(){return this.p}}function Z(h){let t=32,e=0;for(const o of h)o&&(o<t&&(t=o),o>e&&(e=o));if(e===0)return{min:0,max:0,table:new Map};const i=new Uint32Array(e+1);for(const o of h)o&&i[o]++;const s=new Uint32Array(e+1);let r=0;i[0]=0;for(let o=1;o<=e;o++)r=r+i[o-1]<<1,s[o]=r;const n=new Map;for(let o=0;o<h.length;o++){const c=h[o];if(!c)continue;const l=s[c]++;let u=n.get(c);u||(u=[],n.set(c,u)),u[Me(l,c)]=o}return{min:t,max:e,table:n}}function pt(h,t){let e=0;for(let i=1;i<=t.max;i++){e|=h.readBits(1)<<i-1;const s=t.table.get(i);if(s&&e<s.length){const r=s[e];if(r!==void 0)return r}}throw new Error("Invalid Huffman code")}function Me(h,t){let e=0;for(let i=0;i<t;i++)e=e<<1|1&h,h>>>=1;return e>>>0}function Ue(h){if(h.length<2)throw new Error("ZLIB data too short");const t=h[0],e=h[1];if((15&t)!=8)throw new Error("Unsupported ZLIB compression method");if(((t<<8)+e)%31!=0)throw new Error("Bad ZLIB header check");let i=2;32&e&&(i+=4);const s=[];return function(r,n){const o=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258],c=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],l=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],u=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13];let f=0;for(;!f;){f=r.readBits(1);const d=r.readBits(2);if(d===0){r.alignToByte();const g=r.readBits(16);if((65535&(65535^g))!==r.readBits(16))throw new Error("DEFLATE uncompressed LEN/NLEN mismatch");for(let v=0;v<g;v++)n.push(r.readBits(8))}else{if(d!==1&&d!==2)throw new Error("Unsupported DEFLATE type");{let g,v;if(d===1){const A=new Array(288).fill(0);for(let m=0;m<=143;m++)A[m]=8;for(let m=144;m<=255;m++)A[m]=9;for(let m=256;m<=279;m++)A[m]=7;for(let m=280;m<=287;m++)A[m]=8;g=Z(A),v=Z(new Array(32).fill(5))}else{const A=r.readBits(5)+257,m=r.readBits(5)+1,b=r.readBits(4)+4,p=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],y=new Array(19).fill(0);for(let M=0;M<b;M++)y[p[M]]=r.readBits(3);const x=Z(y),E=[];for(;E.length<A+m;){const M=pt(r,x);if(M<=15)E.push(M);else if(M===16){const D=r.readBits(2)+3,I=E[E.length-1]||0;for(let lt=0;lt<D;lt++)E.push(I)}else if(M===17){const D=r.readBits(3)+3;for(let I=0;I<D;I++)E.push(0)}else{if(M!==18)throw new Error("Invalid code length symbol");{const D=r.readBits(7)+11;for(let I=0;I<D;I++)E.push(0)}}}const F=E.slice(0,A),R=E.slice(A,A+m);g=Z(F),v=Z(R)}for(;;){const A=pt(r,g);if(A<256)n.push(A);else{if(A===256)break;if(A>256&&A<286){const m=A-257;let b=o[m];const p=c[m];p&&(b+=r.readBits(p));const y=pt(r,v);if(y>=30)throw new Error("Invalid distance symbol");let x=l[y];const E=u[y];E&&(x+=r.readBits(E));const F=n.length-x;if(F<0)throw new Error("Invalid distance");for(let R=0;R<b;R++)n.push(n[F+R]||0)}else if(A===286||A===287)throw new Error("Reserved length symbol")}}}}}}(new Re(h.subarray(i)),s),new Uint8Array(s)}function Pe(h){const t=P,e=new Uint8Array(h);if(t.readASCII(e,0,4)!=="wOFF")throw new Error("Invalid WOFF signature");const i=t.readUint(e,4),s=t.readUshort(e,12),r=t.readUint(e,16),n=[];let o=44;for(let p=0;p<s;p++){const y=t.readASCII(e,o,4),x=t.readUint(e,o+4),E=t.readUint(e,o+8),F=t.readUint(e,o+12),R=t.readUint(e,o+16);n.push({tag:y,offset:x,compLength:E,origLength:F,checksum:R}),o+=20}for(const p of n){const y=new Uint8Array(e.buffer,p.offset,p.compLength);if(p.compLength===p.origLength)p.data=new Uint8Array(y);else if(p.data=Ue(y),p.data.length!==p.origLength)if(p.data.length<p.origLength){const x=new Uint8Array(p.origLength);x.set(p.data),p.data=x}else p.data=p.data.subarray(0,p.origLength)}const c=s;let l=1,u=0;for(;l<<1<=c;)l<<=1,u++;const f=16*l,d=16*c-f;let g=12+16*c;const v={};for(const p of n)v[p.tag]=g,g=it(g+p.data.length);const A=Math.max(r||0,g),m=new Uint8Array(A);_(m,0,i),st(m,4,c),st(m,6,f),st(m,8,u),st(m,10,d);let b=12;for(const p of n){Fe(m,b,p.tag),b+=4;let y=p.data;if(p.tag==="head"&&y.length>=12){const x=new Uint8Array(y);_(x,8,0),_(m,b,At(x,0,it(x.length))),b+=4}else _(m,b,At(y,0,it(y.length))),b+=4;_(m,b,v[p.tag]),b+=4,_(m,b,p.data.length),b+=4}for(const p of n){const y=v[p.tag];m.set(p.data,y)}if(n.find(p=>p.tag==="head")){const p=v.head,y=function(x,E){const F=E+8,R=[x[F],x[F+1],x[F+2],x[F+3]];_(x,F,0);const M=2981146554-(At(x,0,it(x.length))>>>0)>>>0;return x[F]=R[0],x[F+1]=R[1],x[F+2]=R[2],x[F+3]=R[3],M>>>0}(m,p);_(m,p+8,y)}return m.buffer}const Ce={parseTab(h,t,e){const i={tables:[],ids:{},off:t};h=new Uint8Array(h.buffer,t,e),t=0;const s=P,r=s.readUshort;r(h,t);const n=r(h,t+=2);t+=2;const o=[];for(let c=0;c<n;c++){const l=r(h,t),u=r(h,t+=2);t+=2;const f=s.readUint(h,t);t+=4;const d=`p${l}e${u}`;let g=o.indexOf(f);if(g===-1){let v;g=i.tables.length,o.push(f);const A=r(h,f);v=A===4?this.parse4(h,f):A===12?this.parse12(h,f):{format:A},i.tables.push(v)}i.ids[d]=g}return i},parse4(h,t){const e=P,i=e.readUshort,s=e.readUshorts,r=t,n=i(h,t+=2);i(h,t+=2);const o=i(h,t+=2)>>>1,c={format:4,searchRange:i(h,t+=2),entrySelector:0,rangeShift:0,endCount:[],startCount:[],idDelta:[],idRangeOffset:[],glyphIdArray:[]};t+=2,c.entrySelector=i(h,t),t+=2,c.rangeShift=i(h,t),t+=2,c.endCount=s(h,t,o),t+=2*o,t+=2,c.startCount=s(h,t,o),t+=2*o;for(let l=0;l<o;l++)c.idDelta.push(e.readShort(h,t)),t+=2;return c.idRangeOffset=s(h,t,o),t+=2*o,c.glyphIdArray=s(h,t,r+n-t>>1),c},parse12(h,t){const e=P.readUint;e(h,t+=4),e(h,t+=4);const i=e(h,t+=4);t+=4;const s=new Uint32Array(3*i);for(let r=0;r<3*i;r+=3)s[r]=e(h,t+(r<<2)),s[r+1]=e(h,t+(r<<2)+4),s[r+2]=e(h,t+(r<<2)+8);return{format:12,groups:s}}},Ne={parseTab(h,t,e){const i=P;t+=18;const s=i.readUshort(h,t);t+=2,t+=16;const r=i.readShort(h,t);t+=2;const n=i.readShort(h,t);t+=2;const o=i.readShort(h,t);t+=2;const c=i.readShort(h,t);return t+=2,t+=6,{unitsPerEm:s,xMin:r,yMin:n,xMax:o,yMax:c,indexToLocFormat:i.readShort(h,t)}}},Ie={parseTab(h,t,e){const i=P;t+=4;const s=["ascender","descender","lineGap","advanceWidthMax","minLeftSideBearing","minRightSideBearing","xMaxExtent","caretSlopeRise","caretSlopeRun","caretOffset","res0","res1","res2","res3","metricDataFormat","numberOfHMetrics"],r={};for(let n=0;n<s.length;n++){const o=s[n],c=o==="advanceWidthMax"||o==="numberOfHMetrics"?i.readUshort:i.readShort;r[o]=c(h,t+2*n)}return r}},Se={parseTab(h,t,e,i){const s=P,r=[],n=[],o=i.maxp.numGlyphs,c=i.hhea.numberOfHMetrics;let l=0,u=0,f=0;for(;f<c;)l=s.readUshort(h,t+(f<<2)),u=s.readShort(h,t+(f<<2)+2),r.push(l),n.push(u),f++;for(;f<o;)r.push(l),n.push(u),f++;return{aWidth:r,lsBearing:n}}},It={cmap:Ce,head:Ne,hhea:Ie,maxp:{parseTab(h,t,e){const i=P;return i.readUint(h,t),t+=4,{numGlyphs:i.readUshort(h,t)}}},hmtx:Se,loca:{parseTab(h,t,e,i){const s=P,r=[],n=i.head.indexToLocFormat,o=i.maxp.numGlyphs+1;if(n===0)for(let c=0;c<o;c++)r.push(s.readUshort(h,t+(c<<1))<<1);else if(n===1)for(let c=0;c<o;c++)r.push(s.readUint(h,t+(c<<2)));return r}},glyf:{parseTab(h,t,e,i){const s=[],r=i.maxp.numGlyphs;for(let n=0;n<r;n++)s.push(null);return s},Si(h,t){const e=P,i=h.Ri,s=h.loca;if(s[t]===s[t+1])return null;const r=q.findTable(i,"glyf",h.Ei);if(!r)return null;let n=r[0]+s[t];const o={};if(o.noc=e.readShort(i,n),n+=2,o.xMin=e.readShort(i,n),n+=2,o.yMin=e.readShort(i,n),n+=2,o.xMax=e.readShort(i,n),n+=2,o.yMax=e.readShort(i,n),n+=2,o.xMin>=o.xMax||o.yMin>=o.yMax)return null;if(o.noc>0){o.endPts=[];for(let d=0;d<o.noc;d++)o.endPts.push(e.readUshort(i,n)),n+=2;const c=e.readUshort(i,n);if(n+=2,i.length-n<c)return null;n+=c;const l=o.endPts[o.noc-1]+1;o.flags=[];for(let d=0;d<l;d++){const g=i[n];if(n++,o.flags.push(g),8&g){const v=i[n];n++;for(let A=0;A<v;A++)o.flags.push(g),d++}}o.xs=[];for(let d=0;d<l;d++){const g=o.flags[d],v=!!(16&g);2&g?(o.xs.push(v?i[n]:-i[n]),n++):v?o.xs.push(0):(o.xs.push(e.readShort(i,n)),n+=2)}o.ys=[];for(let d=0;d<l;d++){const g=o.flags[d],v=!!(32&g);4&g?(o.ys.push(v?i[n]:-i[n]),n++):v?o.ys.push(0):(o.ys.push(e.readShort(i,n)),n+=2)}let u=0,f=0;for(let d=0;d<l;d++)u+=o.xs[d],f+=o.ys[d],o.xs[d]=u,o.ys[d]=f}else o.parts=[],o.endPts=[],o.flags=[],o.xs=[],o.ys=[];return o}}},q={parse(h){const t=new Uint8Array(h);P.readASCII(t,0,4)==="wOFF"&&(h=Pe(h));const e=new Uint8Array(h),i=It,s={},r={Ri:e,ki:0,Ei:0};for(const n in i){const o=n,c=q.findTable(e,o,0);if(c){const[l,u]=c;let f=s[l];f==null&&(f=i[o].parseTab(e,l,u,r),s[l]=f),r[o]=f}}return[r]},findTable(h,t,e){const i=P,s=i.readUshort(h,e+4);let r=e+12;for(let n=0;n<s;n++){const o=i.readASCII(h,r,4);i.readUint(h,r+4);const c=i.readUint(h,r+8),l=i.readUint(h,r+12);if(o===t)return[c,l];r+=16}return null},T:It,B:P};class Le{Di(t){var i;const e=[];return(i=t.cmap)!=null&&i.tables?(t.cmap.tables.forEach(s=>{if(s.format===4){const r=this.Li(s);e.push(...r)}else if(s.format===12){const r=this.Oi(s);e.push(...r)}}),[...new Set(e)]):[]}Li(t){const e=[];if(!(t.startCount&&t.endCount&&t.idRangeOffset&&t.idDelta))return e;for(let i=0;i<t.startCount.length;i++){const s=t.startCount[i],r=t.endCount[i];if(s!==65535||r!==65535){for(let n=s;n<=r;n++)if(this.Hi(t,n,i)>0)try{const o=String.fromCodePoint(n);e.push(o)}catch{}}}return e}Oi(t){const e=[];if(!t.groups)return e;for(let i=0;i<t.groups.length;i+=3){const s=t.groups[i],r=t.groups[i+1],n=t.groups[i+2];for(let o=s;o<=r;o++)if(n+(o-s)>0)try{const c=String.fromCodePoint(o);e.push(c)}catch{}}return e}Hi(t,e,i){if(t.idRangeOffset[i]===0)return e+t.idDelta[i]&65535;{const s=t.idRangeOffset[i]/2+(e-t.startCount[i])-(t.startCount.length-i);if(s>=0&&t.glyphIdArray&&s<t.glyphIdArray.length){const r=t.glyphIdArray[s];if(r!==0)return r+t.idDelta[i]&65535}}return 0}}class De{constructor(t){a(this,"Bi");a(this,"Ii");a(this,"K");this.K=t,this.Bi=document.createElement("canvas"),this.Ii=this.Bi.getContext("2d",{willReadFrequently:!0,alpha:!0})}Ni(t,e,i,s){const r=t.length,n=Math.ceil(Math.sqrt(r)),o=Math.ceil(r/n),c=e.width*n,l=e.height*o;this.Gi(c,l),this.ji(t,e,n,i,s);const u=this.K.$i(c,l,1,{filter:"nearest"});return u.et(this.Bi),{framebuffer:u,columns:n,rows:o}}Gi(t,e){this.Bi.width=t,this.Bi.height=e,this.Bi.style.width=t+"px",this.Bi.style.height=e+"px",this.Ii.imageSmoothingEnabled=!1,this.Bi.style.imageRendering="pixelated",this.Ii.clearRect(0,0,t,e),this.Ii.textBaseline="top",this.Ii.textAlign="left",this.Ii.fillStyle="white"}ji(t,e,i,s,r){const n=s/r.head.unitsPerEm;for(let o=0;o<t.length;o++){const c=o%i,l=Math.floor(o/i),u=t[o].glyphData;if(!u)continue;const f=u.advanceWidth*n,d=c*e.width,g=l*e.height,v=d+.5*e.width,A=g+.5*e.height,m=Math.round(v-.5*e.width),b=Math.round(A-.5*s),p=m+.5*(e.width-f),y=b+r.hhea.ascender*n;this.Qi(u,p,y,n)}}Qi(t,e,i,s){if(!t||!t.xs||t.noc===0)return;let{xs:r,ys:n,endPts:o,flags:c}=t;if(!(r&&n&&o&&c))return;this.Ii.beginPath();let l=0;for(let u=0;u<o.length;u++){const f=o[u];if(!(f<l)){if(f>=l){const d=e+r[l]*s,g=i-n[l]*s;this.Ii.moveTo(d,g);let v=l+1;for(;v<=f;)if(1&c[v]){const A=e+r[v]*s,m=i-n[v]*s;this.Ii.lineTo(A,m),v++}else{const A=e+r[v]*s,m=i-n[v]*s;if(v+1>f){const p=e+r[l]*s,y=i-n[l]*s;if(1&c[l])this.Ii.quadraticCurveTo(A,m,p,y);else{const x=(A+p)/2,E=(m+y)/2;this.Ii.quadraticCurveTo(A,m,x,E)}break}const b=v+1;if(1&c[b]){const p=e+r[b]*s,y=i-n[b]*s;this.Ii.quadraticCurveTo(A,m,p,y),v=b+1}else{const p=(A+(e+r[b]*s))/2,y=(m+(i-n[b]*s))/2;this.Ii.quadraticCurveTo(A,m,p,y),v=b}}this.Ii.closePath()}l=f+1}}this.Ii.fill()}}class St{Yi(t,e){const i=t.cmap;if(!i||!i.tables)return 0;let s=0;for(const r of i.tables)if(r.format===4?s=this.Xi(e,r):r.format===12&&(s=this.Wi(e,r)),s>0)break;return s}Ki(t,e){const i=e.codePointAt(0);return i===void 0?0:this.Yi(t,i)}Zi(t,e){const i=t.hmtx;return i&&i.aWidth&&i.aWidth.length!==0?e<i.aWidth.length?i.aWidth[e]:i.aWidth[i.aWidth.length-1]:0}qi(t,e){const i=e/t.head.unitsPerEm,s=t.hhea.ascender*i,r=t.hhea.descender*i,n=t.hhea.lineGap*i;return{ascender:s,descender:r,lineGap:n,lineHeight:s-r+n,unitsPerEm:t.head.unitsPerEm,scale:i}}Xi(t,e){const i=e.endCount.length;let s=-1;for(let r=0;r<i;r++)if(t<=e.endCount[r]){s=r;break}if(s===-1||t<e.startCount[s])return 0;if(e.idRangeOffset[s]===0)return t+e.idDelta[s]&65535;{const r=e.idRangeOffset[s]/2+(t-e.startCount[s])-(i-s);if(r>=0&&r<e.glyphIdArray.length){const n=e.glyphIdArray[r];return n===0?0:n+e.idDelta[s]&65535}}return 0}Wi(t,e){const i=e.groups.length/3;for(let s=0;s<i;s++){const r=e.groups[3*s],n=e.groups[3*s+1],o=e.groups[3*s+2];if(t>=r&&t<=n)return o+(t-r)}return 0}}class _e{constructor(){a(this,"Vi");this.Vi=new St}Ji(t,e,i){let s=0;const r=this.Vi.qi(i,e),n=r.lineHeight;for(const o of t){const c=this.Vi.Ki(i,o);if(c===0)continue;const l=this.Vi.Zi(i,c)*r.scale;s=Math.max(s,l)}return{width:Math.ceil(s),height:Math.ceil(n)}}}class ze{constructor(){a(this,"tr");this.tr=new St}sr(t,e){const i=[],s=new Map;return t.forEach((r,n)=>{const o=r.codePointAt(0)||0,c={character:r,unicode:o,color:this.er(n),glyphData:this.ir(e,r)};i.push(c),s.set(r,c)}),{array:i,map:s}}er(t){return[t%256/255,Math.floor(t/256)%256/255,0]}ir(t,e){const i=e.codePointAt(0)||0,s=this.tr.Yi(t,i);if(s===0)return null;let r=0;t.hmtx&&t.hmtx.aWidth&&s>0&&t.hmtx.aWidth[s]!==void 0&&(r=t.hmtx.aWidth[s]);const n=q.T.glyf.Si(t,s);return n?{...n,advanceWidth:r}:null}}class rt{constructor(t,e=16){a(this,"rr");a(this,"nr",[]);a(this,"hr",new Map);a(this,"ar");a(this,"cr",16);a(this,"lr",0);a(this,"ur",0);a(this,"dr",{width:0,height:0});a(this,"vr");a(this,"pr");a(this,"mr");a(this,"gr");a(this,"_r");a(this,"yr",!1);this.cr=e,this.pr=new Le,this.mr=new De(t),this.gr=new _e,this._r=new ze}async Ar(t){if(this.yr)return;let e;if(t){const i=await fetch(t);if(!i.ok)throw new T(`Failed to load font file: ${i.status} ${i.statusText}`);e=await i.arrayBuffer()}else e=await(await fetch("data:font/woff;base64,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")).arrayBuffer();await this.br(e),this.rr=q.parse(e)[0],await this.wr()}Mr(t){if(t===void 0)return this.cr;this.cr=t,this.dr=this.gr.Ji(this.nr.map(i=>i.character),this.cr,this.rr);const e=this.mr.Ni(this.nr,this.dr,this.cr,this.rr);this.ar=e.framebuffer,this.lr=e.columns,this.ur=e.rows}async Cr(t){try{const e=await fetch(t);if(!e.ok)throw new T(`Failed to load font file: ${e.status} ${e.statusText}`);const i=await e.arrayBuffer();await this.br(i);const s=q.parse(i);if(!s||s.length===0)throw new Error("Failed to parse font file");this.rr=s[0],await this.wr()}catch(e){throw new T(`Failed to load font: ${e instanceof Error?e.message:"Unknown error"}`,e)}}async br(t){const e=Date.now();this.vr=new FontFace(`CustomFont_${e}`,t),await this.vr.load(),document.fonts.add(this.vr)}async wr(){const t=this.pr.Di(this.rr),{array:e,map:i}=this._r.sr(t,this.rr);this.nr=e,this.hr=i,this.dr=this.gr.Ji(t,this.cr,this.rr);const s=this.mr.Ni(this.nr,this.dr,this.cr,this.rr);this.ar=s.framebuffer,this.lr=s.columns,this.ur=s.rows,this.yr=!0}Fr(t){const e=this.hr.get(t);return e?e.color:[0,0,0]}$r(t){return Array.from(t).map(e=>{const i=this.hr.get(e);return i?i.color:[0,0,0]})}Fs(){this.ar.dispose(),document.fonts.delete(this.vr)}get Pr(){return this.yr}get fontFramebuffer(){return this.ar}get characterMap(){return this.hr}get characters(){return this.nr}get textureColumns(){return this.lr}get textureRows(){return this.ur}get maxGlyphDimensions(){return this.dr}get fontSize(){return this.cr}get font(){return this.rr}}class Lt{constructor(t,e,i){a(this,"Tr");a(this,"zr");a(this,"N");a(this,"G");a(this,"Sr");a(this,"Rr");a(this,"Er");a(this,"kr");a(this,"Dr");a(this,"Lr",!1);a(this,"Or",new Set);this.Er=t,this.kr=e,this.Dr=i,this.Js()}Hr(){if(this.N=this.Tr*this.kr,this.G=this.zr*this.Dr,this.Sr=Math.floor((this.Er.width-this.N)/2),this.Rr=Math.floor((this.Er.height-this.G)/2),this.Or.size>0)for(const t of this.Or)t()}Br(t){this.Or.add(t)}Ir(t){this.Or.delete(t)}Js(){this.Lr||(this.Tr=Math.floor(this.Er.width/this.kr),this.zr=Math.floor(this.Er.height/this.Dr)),this.Hr()}Nr(t,e){this.kr=t,this.Dr=e,this.Js()}get cellWidth(){return this.kr}get cellHeight(){return this.Dr}get cols(){return this.Tr}set cols(t){this.Lr=!0,this.Tr=Math.max(1,Math.floor(t)),typeof this.zr!="number"&&(this.zr=Math.max(1,Math.floor(this.Er.height/this.Dr))),this.Hr()}get rows(){return this.zr}set rows(t){this.Lr=!0,this.zr=Math.max(1,Math.floor(t)),typeof this.Tr!="number"&&(this.Tr=Math.max(1,Math.floor(this.Er.width/this.kr))),this.Hr()}get width(){return this.N}get height(){return this.G}get offsetX(){return this.Sr}get offsetY(){return this.Rr}responsive(){this.Lr=!1}Fs(){this.Or.clear()}}const Oe=/^rgba?\(([^)]+)\)$/i;function yt(h){return Number.isNaN(h)?0:Math.max(0,Math.min(255,h))}function Be(h){if(!h)return null;const t=h.trim().toLowerCase();if(!t)return null;let e=null;return t.startsWith("rgb")&&(e=function(i){const s=Oe.exec(i.trim());if(!s)return null;const r=s[1].split(",").map(u=>u.trim());if(r.length<3)return null;const n=yt(parseFloat(r[0])),o=yt(parseFloat(r[1])),c=yt(parseFloat(r[2])),l=r[3]!==void 0?255*Math.max(0,Math.min(1,parseFloat(r[3]))):255;return[n,o,c,Math.round(l)]}(t)),e?e[3]===0?null:e:null}class Dt{constructor(t={}){a(this,"Er");a(this,"Gr",null);a(this,"jr",!1);a(this,"Qr");this.jr=t.overlay??!1,this.jr&&t.canvas?(this.Gr=t.canvas,this.Er=this.Yr(),this.Qr=!0,this.Xr()):t.canvas?(this.Er=t.canvas,this.Qr=!1):(this.Er=this.Wr(t.width,t.height),this.Qr=!0),this.Er.style.imageRendering="pixelated"}Wr(t,e){const i=document.createElement("canvas");return i.className="textmodeCanvas",i.style.imageRendering="pixelated",i.width=t||800,i.height=e||600,document.body.appendChild(i),i}Yr(){const t=document.createElement("canvas");t.className="textmodeCanvas",t.style.imageRendering="pixelated";const e=this.Gr.getBoundingClientRect();let i=Math.round(e.width),s=Math.round(e.height);if(this.Gr instanceof HTMLVideoElement){const o=this.Gr;(i===0||s===0)&&o.videoWidth>0&&o.videoHeight>0&&(i=o.videoWidth,s=o.videoHeight)}t.width=i,t.height=s,t.style.position="absolute",t.style.pointerEvents="none";const r=window.getComputedStyle(this.Gr);let n=parseInt(r.zIndex||"0",10);return isNaN(n)&&(n=0),t.style.zIndex=(n+1).toString(),t}Xr(){var t;this.Kr(),(t=this.Gr.parentNode)==null||t.insertBefore(this.Er,this.Gr.nextSibling)}Zr(){const t=[];return this.jr&&this.Gr instanceof HTMLElement&&(t.push(this.Gr),this.Gr.parentElement&&t.push(this.Gr.parentElement)),this.Er.parentElement&&t.push(this.Er.parentElement),t.push(this.Er),t.push(document.body),t.push(document.documentElement),t}qr(){const t=this.Zr();for(const e of t){if(!e)continue;const i=Be(window.getComputedStyle(e).backgroundColor);if(i)return i}return[255,255,255,255]}Kr(){if(!this.Gr)return;const t=this.Gr.getBoundingClientRect();let e=this.Gr.offsetParent;if(e&&e!==document.body){const i=e.getBoundingClientRect();this.Er.style.top=t.top-i.top+"px",this.Er.style.left=t.left-i.left+"px"}else this.Er.style.top=t.top+window.scrollY+"px",this.Er.style.left=t.left+window.scrollX+"px"}Vr(t,e){if(this.jr){const i=this.Gr.getBoundingClientRect();this.Er.width=Math.round(i.width),this.Er.height=Math.round(i.height),this.Kr()}else this.Er.width=t??this.Er.width,this.Er.height=e??this.Er.height}Jr(){const t=this.Er.getContext("webgl2",{alpha:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!0,antialias:!1,depth:!0,stencil:!1,powerPreference:"high-performance"});if(!t)throw new T("`textmode.js` requires WebGL2 support.");return t}Fs(){const t=this.Er.getContext("webgl")||this.Er.getContext("webgl2");if(t){const e=t.getExtension("WEBGL_lose_context");e==null||e.loseContext()}this.Qr&&this.Er.parentNode&&this.Er.parentNode.removeChild(this.Er)}get canvas(){return this.Er}get targetCanvas(){return this.Gr}get width(){return this.Er.width}get height(){return this.Er.height}}function nt(h){return X(parseInt(h,16),0,255)}class C{constructor(t,e,i,s){a(this,"tn");a(this,"sn");a(this,"r");a(this,"g");a(this,"b");a(this,"a");this.r=X(t,0,255),this.g=X(e,0,255),this.b=X(i,0,255),this.a=X(s,0,255),this.tn=[this.r,this.g,this.b,this.a],this.sn=[this.r/255,this.g/255,this.b/255,this.a/255]}static en(t,e,i,s){if(C.rn(t))return t;if(Array.isArray(t)){if(t.length<3)throw new Error("Component tuples must include at least RGB values.");const[r,n,o]=t,c=t.length===4?t[3]:255;return C.nn(r,n,o,c)}if(typeof t=="string"){const r=t.trim();if(r.length===0)throw new Error("Color strings cannot be empty.");return C.hn(r)}if(typeof t=="number")return typeof e=="number"&&typeof i=="number"?C.nn(t,e,i,s??255):C.an(t);throw new Error("Unsupported color input passed to TextmodeColor.$from.")}static nn(t,e,i,s=255){return new C(t,e,i,s)}static an(t,e=255){return new C(t,t,t,e)}static hn(t){return new C(...function(e){const i=e.replace(/^#|0x/gi,""),s=(r=i).length===3||r.length===4?r.split("").map(n=>n+n).join(""):r;var r;if(s.length!==6&&s.length!==8)throw new Error(`Invalid hex color: ${e}`);return[nt(s.slice(0,2)),nt(s.slice(2,4)),nt(s.slice(4,6)),s.length===8?nt(s.slice(6,8)):255]}(t))}get rgb(){return[this.r,this.g,this.b]}get rgba(){return[...this.tn]}get normalized(){return[...this.sn]}withAlpha(t){return new C(this.r,this.g,this.b,t)}static rn(t){return t instanceof C}}class _t{constructor(t,e,i,s,r,n,o,c){a(this,"A");a(this,"K");a(this,"cn");a(this,"ln");a(this,"un");a(this,"N");a(this,"G");a(this,"Z",null);a(this,"fn",null);a(this,"dn","brightness");a(this,"vn",null);a(this,"pn");a(this,"Pt",0);a(this,"Bt",0);a(this,"It",0);a(this,"Tt",0);a(this,"mn","sampled");a(this,"gn","fixed");a(this,"Gt",[1,1,1,1]);a(this,"jt",[0,0,0,1]);a(this,"_n",[0,0,0,1]);a(this,"yn",[[.1,0,0]]);a(this,"An",null);this.A=t,this.K=e,this.cn=i,this.pn=s,this.ln=r,this.un=n,this.N=o,this.G=c}conversionMode(t){return this.dn=t,this.vn=null,this.Z=null,this}Fs(){this.A.deleteTexture(this.cn)}invert(t=!0){return this.Pt=t?1:0,this.Z=null,this}flipX(t=!0){return this.Bt=t?1:0,this.Z=null,this}flipY(t=!0){return this.It=t?1:0,this.Z=null,this}charRotation(t){return this.Tt=Tt(t),this.Z=null,this}charColorMode(t){return this.mn=t,this.Z=null,this}cellColorMode(t){return this.gn=t,this.Z=null,this}charColor(t,e,i,s){return this.bn(this.Gt,t,e,i,s),this.Z=null,this}cellColor(t,e,i,s){return this.bn(this.jt,t,e,i,s),this.Z=null,this}background(t,e,i,s){return this.bn(this._n,t,e,i,s),this.Z=null,this}characters(t){return this.An=t,this.wn(t),this.Z=null,this}yi(t){this.fn!==t&&(this.fn=t,this.An&&this.wn(this.An),this.Z=null)}get texture(){return this.cn}get width(){return this.N}get height(){return this.G}get originalWidth(){return this.ln}get originalHeight(){return this.un}lt(){return this.Z||this.ut(),this.Z}xn(){}ut(){this.xn();const t=this.Mn(),e=this.Cn(),i=t.createShader(e),s=t.createUniforms(e);this.Z=this.K.materialManager.Ne(i,s)}bn(t,e,i,s,r){const n=C.en(e,i,s,r);tt(t,n.r,n.g,n.b,n.a)}wn(t){if(!this.fn)return;const e=this.fn.$r(t).filter(i=>Array.isArray(i)).slice(0,255);this.yn=e.length>0?e:this.yn}createBaseConversionUniforms(){return{u_image:this.Fn(),u_invert:!!this.Pt,u_flipX:!!this.Bt,u_flipY:!!this.It,u_charRotation:this.Tt,u_charColorFixed:this.mn==="fixed",u_charColor:this.Gt,u_cellColorFixed:this.gn==="fixed",u_cellColor:this.jt,u_backgroundColor:this._n,u_charCount:this.yn.length,u_charList:this.yn}}Mn(){if(this.vn&&this.vn.id===this.dn)return this.vn;const t=this.pn.$n(this.dn);if(!t)throw new Error(`[textmode.js] Conversion mode "${this.dn}" is not registered. If this mode is provided by an add-on, make sure its plugin is installed before loading sources.`);return this.vn=t,t}Cn(){if(!this.fn)throw new Error("[textmode.js] Cannot create conversion context: no active font set. Ensure $setActiveFont() is called before rendering.");return{renderer:this.K,gl:this.A,font:this.fn,source:this,gridWidth:this.N,gridHeight:this.G}}}class J extends _t{constructor(t,e,i,s,r,n,o,c){const l=Math.min(o/r,c/n);super(t,e,i,s,r,n,Math.max(1,Math.floor(r*l)),Math.max(1,Math.floor(n*l)))}static Pn(t,e,i,s,r){const n=t.context,o=n.createTexture();n.bindTexture(n.TEXTURE_2D,o),n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,1),dt(n,n.NEAREST,n.NEAREST,n.CLAMP_TO_EDGE,n.CLAMP_TO_EDGE),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,i),n.bindTexture(n.TEXTURE_2D,null);const c=i.naturalWidth??i.width??i.videoWidth??0,l=i.naturalHeight??i.height??i.videoHeight??0;return new J(n,t,o,e,c,l,s,r)}Fn(){return this.cn}}class zt{constructor(t=60){a(this,"Tn");a(this,"zn",null);a(this,"Sn",0);a(this,"Rn",!0);a(this,"En",0);a(this,"kn",0);a(this,"Dn",[]);a(this,"Ln",10);a(this,"On",0);a(this,"Hn",0);a(this,"Bn",-1);this.Tn=1e3/t}In(t){if(!this.Rn)return;this.Bn===-1&&(this.Bn=performance.now()),this.Sn=performance.now();const e=i=>{if(!this.Rn)return void(this.zn=null);const s=i-this.Sn;s>=this.Tn&&(t(),this.Sn=i-s%this.Tn),this.Rn&&(this.zn=requestAnimationFrame(e))};this.zn=requestAnimationFrame(e)}Nn(){this.zn&&(cancelAnimationFrame(this.zn),this.zn=null)}Gn(){this.Rn&&(this.Rn=!1,this.Nn())}jn(t){this.Rn||(this.Rn=!0,this.In(t))}Qn(t,e){if(t===void 0)return this.En;this.Tn=1e3/t,this.Rn&&e&&(this.Nn(),this.In(e))}Yn(){const t=performance.now();if(this.kn>0){const e=t-this.kn;this.On=e,this.Dn.push(e),this.Dn.length>this.Ln&&this.Dn.shift();const i=this.Dn.reduce((s,r)=>s+r,0)/this.Dn.length;this.En=1e3/i}this.kn=t}get Xn(){return this.Rn}get Wn(){return this.En}get Kn(){return this.Hn}set Kn(t){this.Hn=t}Zn(){this.Hn++}qn(){return this.Bn===-1?0:performance.now()-this.Bn}Vn(){return this.qn()/1e3}get Jn(){return this.On}}class Ot{constructor(t,e){a(this,"Er");a(this,"so");a(this,"eo",{x:Number.NEGATIVE_INFINITY,y:Number.NEGATIVE_INFINITY});a(this,"io",{x:Number.NEGATIVE_INFINITY,y:Number.NEGATIVE_INFINITY});a(this,"ro",null);a(this,"no",0);a(this,"oo");a(this,"ho");a(this,"ao");a(this,"co");a(this,"lo");a(this,"uo");a(this,"fo",!1);a(this,"do");a(this,"vo");a(this,"po");a(this,"mo");a(this,"_o");this.Er=t,this.so=e}yo(t){const e=performance.now()+Math.max(0,t);e>this.no&&(this.no=e)}Ao(){return performance.now()<this.no}bo(t){const e=this.Er.canvas;e.style.cursor=t==null||t===""?"":t}wo(){if(this.fo)return;const t=this.Er.canvas;this.oo=e=>{this.xo(e),this.Mo(e)},this.ho=()=>{this.io={...this.eo},this.eo.x=Number.NEGATIVE_INFINITY,this.eo.y=Number.NEGATIVE_INFINITY,this.ro=null},this.ao=e=>{this.xo(e),this.Co(e)},this.co=e=>{this.xo(e),this.Fo(e)},this.lo=e=>{this.xo(e),this.$o(e)},this.uo=e=>{this.xo(e),this.Po(e)},t.addEventListener("mousemove",this.oo,{passive:!0}),t.addEventListener("mouseleave",this.ho,{passive:!0}),t.addEventListener("mousedown",this.ao,{passive:!0}),t.addEventListener("mouseup",this.co,{passive:!0}),t.addEventListener("click",this.lo,{passive:!0}),t.addEventListener("wheel",this.uo,{passive:!1}),this.fo=!0}To(){if(!this.fo)return;const t=this.Er.canvas;t.removeEventListener("mousemove",this.oo),t.removeEventListener("mouseleave",this.ho),t.removeEventListener("mousedown",this.ao),t.removeEventListener("mouseup",this.co),t.removeEventListener("click",this.lo),t.removeEventListener("wheel",this.uo),this.fo=!1}zo(){if(!this.fo)return;const t=this.so();if(t)try{if(this.ro){const e=new MouseEvent("mousemove",{clientX:this.ro.x,clientY:this.ro.y,bubbles:!1,cancelable:!1});this.xo(e)}else{const e=Math.floor((t.cols-1)/2),i=Math.floor(t.rows/2);if(this.eo.x!==Number.NEGATIVE_INFINITY&&this.eo.y!==Number.NEGATIVE_INFINITY){const s=-e,r=t.cols-e-1,n=-i,o=t.rows-i-1;(this.eo.x<s||this.eo.x>r||this.eo.y<n||this.eo.y>o)&&(this.eo.x=Number.NEGATIVE_INFINITY,this.eo.y=Number.NEGATIVE_INFINITY)}}}catch{this.eo.x=Number.NEGATIVE_INFINITY,this.eo.y=Number.NEGATIVE_INFINITY}}So(t){this.do=t}Ro(t){this.vo=t}Eo(t){this.po=t}ko(t){this.mo=t}Do(t){this._o=t}Lo(){return{x:this.eo.x,y:this.eo.y}}Mo(t){if(this.mo&&!this.Ao()){const e={position:{...this.eo},previousPosition:{...this.io},originalEvent:t};this.mo(e)}}Co(t){if(this.vo&&!this.Ao()){const e={position:{...this.eo},previousPosition:{...this.io},button:t.button,originalEvent:t};this.vo(e)}}Fo(t){if(this.po&&!this.Ao()){const e={position:{...this.eo},previousPosition:{...this.io},button:t.button,originalEvent:t};this.po(e)}}$o(t){if(this.do&&!this.Ao()){const e={position:{...this.eo},previousPosition:{...this.io},button:t.button,originalEvent:t};this.do(e)}}Po(t){if(this._o&&!this.Ao()){const e={position:{...this.eo},previousPosition:{...this.io},delta:{x:t.deltaX,y:t.deltaY},originalEvent:t};this._o(e)}}xo(t){const e=this.Er.canvas,i=this.so();if(this.io={...this.eo},this.ro={x:t.clientX,y:t.clientY},!i)return this.eo.x=Number.NEGATIVE_INFINITY,void(this.eo.y=Number.NEGATIVE_INFINITY);const s=e.getBoundingClientRect(),r=t.clientX-s.left,n=t.clientY-s.top,o=e.width/s.width,c=n*(e.height/s.height),l=r*o-i.offsetX,u=c-i.offsetY,f=Math.floor(l/i.cellWidth),d=Math.floor(u/i.cellHeight);if(f>=0&&f<i.cols&&d>=0&&d<i.rows){const g=Math.floor((i.cols-1)/2);this.eo.x=f-g,this.eo.y=d-Math.floor(i.rows/2)}else this.eo.x=Number.NEGATIVE_INFINITY,this.eo.y=Number.NEGATIVE_INFINITY}}const Ge=Object.freeze(Object.defineProperty({__proto__:null,MouseManager:Ot},Symbol.toStringTag,{value:"Module"}));class Bt{constructor(){a(this,"Oo",new Map);a(this,"Ho",null);a(this,"Bo",null);a(this,"Io");a(this,"No");a(this,"fo",!1);a(this,"Go");a(this,"jo");a(this,"Qo",{ArrowUp:"UP_ARROW",ArrowDown:"DOWN_ARROW",ArrowLeft:"LEFT_ARROW",ArrowRight:"RIGHT_ARROW",F1:"F1",F2:"F2",F3:"F3",F4:"F4",F5:"F5",F6:"F6",F7:"F7",F8:"F8",F9:"F9",F10:"F10",F11:"F11",F12:"F12",Enter:"ENTER",Return:"RETURN",Tab:"TAB",Escape:"ESCAPE",Backspace:"BACKSPACE",Delete:"DELETE",Insert:"INSERT",Home:"HOME",End:"END",PageUp:"PAGE_UP",PageDown:"PAGE_DOWN",Shift:"SHIFT",Control:"CONTROL",Alt:"ALT",Meta:"META"," ":"SPACE"})}wo(){this.fo||(this.Io=t=>{this.Yo(t)},this.No=t=>{this.Xo(t)},window.addEventListener("keydown",this.Io,{passive:!1}),window.addEventListener("keyup",this.No,{passive:!1}),this.fo=!0)}To(){this.fo&&(window.removeEventListener("keydown",this.Io),window.removeEventListener("keyup",this.No),this.fo=!1,this.Oo.clear(),this.Ho=null,this.Bo=null)}Ro(t){this.Go=t}Eo(t){this.jo=t}Wo(t){const e=this.Ko(t),i=this.Oo.get(t)||this.Oo.get(e);return(i==null?void 0:i.isPressed)||!1}Zo(){return this.Ho}qo(){return this.Bo}Vo(){const t=[];for(const[e,i]of this.Oo)i.isPressed&&t.push(e);return t}Jo(){return{ctrl:this.Wo("Control"),shift:this.Wo("Shift"),alt:this.Wo("Alt"),meta:this.Wo("Meta")}}th(){this.Oo.clear(),this.Ho=null,this.Bo=null}Yo(t){const e=t.key,i=Date.now();this.Oo.has(e)||this.Oo.set(e,{isPressed:!1,lastPressTime:0,lastReleaseTime:0});const s=this.Oo.get(e);if(!s.isPressed&&(s.isPressed=!0,s.lastPressTime=i,this.Ho=e,this.Go)){const r={key:e,keyCode:t.keyCode,ctrlKey:t.ctrlKey,shiftKey:t.shiftKey,altKey:t.altKey,metaKey:t.metaKey,isPressed:!0,originalEvent:t};this.Go(r)}}Xo(t){const e=t.key,i=Date.now();this.Oo.has(e)||this.Oo.set(e,{isPressed:!1,lastPressTime:0,lastReleaseTime:0});const s=this.Oo.get(e);if(s.isPressed=!1,s.lastReleaseTime=i,this.Bo=e,this.jo){const r={key:e,keyCode:t.keyCode,ctrlKey:t.ctrlKey,shiftKey:t.shiftKey,altKey:t.altKey,metaKey:t.metaKey,isPressed:!1,originalEvent:t};this.jo(r)}}Ko(t){return this.Qo[t]||t.toLowerCase()}}const Ye=Object.freeze(Object.defineProperty({__proto__:null,KeyboardManager:Bt},Symbol.toStringTag,{value:"Module"}));class Gt{constructor(t,e,i){a(this,"Er");a(this,"sh");a(this,"so");a(this,"eh",new Map);a(this,"ih",new Map);a(this,"rh",new Map);a(this,"nh",null);a(this,"oh");a(this,"hh");a(this,"ah");a(this,"uh");a(this,"fh");a(this,"dh");a(this,"fo",!1);a(this,"ph");a(this,"mh");a(this,"gh");a(this,"_h");a(this,"yh");a(this,"Ah");a(this,"bh");a(this,"wh");a(this,"xh");a(this,"Mh");a(this,"Ch",320);a(this,"Fh",350);a(this,"$h",10);a(this,"Ph",550);a(this,"Th",14);a(this,"zh",48);a(this,"Sh",650);a(this,"Rh",.02);a(this,"Eh",2);a(this,"kh",600);a(this,"Dh",0);a(this,"Lh",null);this.Er=t,this.so=e,this.sh=i;const s=this.Er.canvas;this.oh=s.style.touchAction,this.hh=s.style.userSelect,s.style.touchAction||(s.style.touchAction="none"),s.style.userSelect||(s.style.userSelect="none")}wo(){if(this.fo)return;const t=this.Er.canvas;this.ah=e=>{this.Oh(e)},this.uh=e=>{this.Hh(e)},this.fh=e=>{this.Bh(e)},this.dh=e=>{this.Ih(e)},t.addEventListener("touchstart",this.ah,{passive:!1}),t.addEventListener("touchmove",this.uh,{passive:!1}),t.addEventListener("touchend",this.fh,{passive:!1}),t.addEventListener("touchcancel",this.dh,{passive:!1}),this.fo=!0}To(){if(!this.fo)return;const t=this.Er.canvas;t.removeEventListener("touchstart",this.ah),t.removeEventListener("touchmove",this.uh),t.removeEventListener("touchend",this.fh),t.removeEventListener("touchcancel",this.dh),this.fo=!1,this.nh=null,this.eh.clear(),this.ih.clear(),this.rh.forEach(e=>{e.longPressTimer!==null&&window.clearTimeout(e.longPressTimer)}),this.rh.clear(),this.Lh=null,this.Dh=0,t.style.touchAction=this.oh,t.style.userSelect=this.hh}zo(){if(!this.so()||this.eh.size===0)return;const t=new Map;for(const e of this.eh.values()){const i=this.Nh(e.clientX,e.clientY,e.id,e);t.set(e.id,i)}this.eh=t}Gh(){return Array.from(this.eh.values()).map(t=>({...t}))}jh(t){this.ph=t}ko(t){this.mh=t}Qh(t){this.gh=t}Yh(t){this._h=t}Xh(t){this.yh=t}Wh(t){this.Ah=t}Kh(t){this.bh=t}Zh(t){this.wh=t}qh(t){this.xh=t}Vh(t){this.Mh=t}Oh(t){var s;if(!this.so())return;t.preventDefault(),(s=this.sh)==null||s.yo(this.kh);const e=performance.now(),i=this.Jh(t.changedTouches);for(const r of i){const n=this.eh.get(r.id);n&&this.ih.set(r.id,this.ta(n)),this.eh.set(r.id,r);const o={id:r.id,startPosition:r,lastPosition:r,startTime:e,lastTime:e,longPressTimer:null,longPressFired:!1};this.bh&&(o.longPressTimer=window.setTimeout(()=>{const c=this.eh.get(r.id);c&&(o.longPressFired=!0,this.bh({touch:this.ta(c),duration:performance.now()-o.startTime,originalEvent:t}))},this.Ph)),this.rh.set(r.id,o),this.ph&&this.ph(this.sa(r,t,void 0,e))}this.eh.size===2&&this.ea()}Hh(t){var s;if(!this.so())return;t.preventDefault(),(s=this.sh)==null||s.yo(this.kh);const e=performance.now(),i=this.Jh(t.changedTouches);for(const r of i){const n=this.eh.get(r.id),o=n?this.ta(n):void 0;o&&this.ih.set(r.id,o),this.eh.set(r.id,r);const c=this.rh.get(r.id);c&&(c.lastPosition=r,c.lastTime=e,o)&&W(o.clientX,o.clientY,r.clientX,r.clientY)>this.Th&&c.longPressTimer!==null&&(window.clearTimeout(c.longPressTimer),c.longPressTimer=null),this.mh&&this.mh(this.sa(r,t,o,e))}this.eh.size===2?this.ia(t):this.nh=null}Bh(t){if(!this.so())return;t.preventDefault();const e=performance.now(),i=this.Jh(t.changedTouches);for(const s of i){const r=this.eh.get(s.id),n=r?this.ta(r):void 0,o=this.rh.get(s.id);o&&o.longPressTimer!==null&&(window.clearTimeout(o.longPressTimer),o.longPressTimer=null),this.gh&&this.gh(this.sa(s,t,n,e)),o&&this.ra(o,t),this.rh.delete(s.id),this.ih.delete(s.id),this.eh.delete(s.id)}this.eh.size<2&&(this.nh=null)}Ih(t){if(!this.so())return;t.preventDefault();const e=performance.now(),i=this.Jh(t.changedTouches);for(const s of i){const r=this.eh.get(s.id),n=r?this.ta(r):void 0,o=this.rh.get(s.id);o&&o.longPressTimer!==null&&(window.clearTimeout(o.longPressTimer),o.longPressTimer=null),this._h&&this._h(this.sa(s,t,n,e)),this.rh.delete(s.id),this.ih.delete(s.id),this.eh.delete(s.id)}this.eh.size<2&&(this.nh=null)}Jh(t){const e=[];for(let i=0;i<t.length;i+=1){const s=t.item(i);s&&e.push(this.na(s))}return e}na(t){return this.Nh(t.clientX,t.clientY,t.identifier,{id:t.identifier,x:-1,y:-1,clientX:t.clientX,clientY:t.clientY,pressure:t.force,radiusX:t.radiusX,radiusY:t.radiusY,rotationAngle:t.rotationAngle})}Nh(t,e,i,s){const r=this.Er.canvas,n=this.so(),o=r.getBoundingClientRect(),c=t-o.left,l=e-o.top,u=c*(r.width/o.width),f=l*(r.height/o.height);if(!n)return{id:i,x:Number.NEGATIVE_INFINITY,y:Number.NEGATIVE_INFINITY,clientX:t,clientY:e,pressure:s.pressure,radiusX:s.radiusX,radiusY:s.radiusY,rotationAngle:s.rotationAngle};const d=u-n.offsetX,g=f-n.offsetY,v=Math.floor(d/n.cellWidth),A=Math.floor(g/n.cellHeight);return v>=0&&v<n.cols&&A>=0&&A<n.rows?{id:i,x:v-Math.floor((n.cols-1)/2),y:A-Math.floor(n.rows/2),clientX:t,clientY:e,pressure:s.pressure,radiusX:s.radiusX,radiusY:s.radiusY,rotationAngle:s.rotationAngle}:{id:i,x:Number.NEGATIVE_INFINITY,y:Number.NEGATIVE_INFINITY,clientX:t,clientY:e,pressure:s.pressure,radiusX:s.radiusX,radiusY:s.radiusY,rotationAngle:s.rotationAngle}}sa(t,e,i,s){const r=this.rh.get(t.id),n=Array.from(this.ih.values()).map(l=>this.ta(l)),o=Array.from(this.eh.values()).map(l=>this.ta(l)),c=this.Jh(e.changedTouches);return{touch:this.ta(t),previousTouch:i?this.ta(i):void 0,touches:o,previousTouches:n,changedTouches:c,deltaTime:r?s-r.lastTime:0,originalEvent:e}}ea(){if(this.eh.size!==2)return void(this.nh=null);const t=Array.from(this.eh.values()),[e,i]=t,s=W(e.x,e.y,i.x,i.y),r=wt(e.clientX,e.clientY,i.clientX,i.clientY);this.nh={ids:[e.id,i.id],initialDistance:Math.max(s,1e-4),initialAngle:r,lastScale:1,lastRotation:0}}ia(t){if(this.nh||this.ea(),!this.nh)return;const[e,i]=this.nh.ids,s=this.eh.get(e),r=this.eh.get(i);if(!s||!r)return;const n=W(s.x,s.y,r.x,r.y)/this.nh.initialDistance,o=n-this.nh.lastScale;this.xh&&Math.abs(o)>this.Rh&&(this.xh({touches:[this.ta(s),this.ta(r)],scale:n,deltaScale:o,center:this.oa(s,r),originalEvent:t}),this.nh.lastScale=n);let c=wt(s.clientX,s.clientY,r.clientX,r.clientY)-this.nh.initialAngle;c=(c+180)%360-180;const l=c-this.nh.lastRotation;this.Mh&&Math.abs(l)>this.Eh&&(this.Mh({touches:[this.ta(s),this.ta(r)],rotation:c,deltaRotation:l,center:this.oa(s,r),originalEvent:t}),this.nh.lastRotation=c)}oa(t,e){const i=(t.clientX+e.clientX)/2,s=(t.clientY+e.clientY)/2,r=this.Nh(i,s,-1,{id:-1,x:-1,y:-1,clientX:i,clientY:s});return{x:r.x,y:r.y}}ra(t,e){const i=performance.now(),s=i-t.startTime,r=W(t.startPosition.clientX,t.startPosition.clientY,t.lastPosition.clientX,t.lastPosition.clientY);if(!t.longPressFired&&s<=this.Ch&&r<=this.$h)this.ha(t.lastPosition,i)&&this.Ah?this.Ah({touch:this.ta(t.lastPosition),taps:2,originalEvent:e}):this.yh&&this.yh({touch:this.ta(t.lastPosition),taps:1,originalEvent:e});else if(!t.longPressFired&&s<=this.Sh&&r>=this.zh){const n={x:t.lastPosition.clientX-t.startPosition.clientX,y:t.lastPosition.clientY-t.startPosition.clientY},o=Math.max(Math.hypot(n.x,n.y),1e-4),c={x:n.x/o,y:n.y/o},l={x:n.x/s,y:n.y/s};this.wh&&this.wh({touch:this.ta(t.lastPosition),direction:c,distance:o,velocity:l,originalEvent:e})}this.Dh=i,this.Lh=this.ta(t.lastPosition)}ha(t,e){return!this.Lh||e-this.Dh>this.Fh?!1:W(t.clientX,t.clientY,this.Lh.clientX,this.Lh.clientY)<=this.$h}ta(t){return{...t}}}const Xe=Object.freeze(Object.defineProperty({__proto__:null,TouchManager:Gt},Symbol.toStringTag,{value:"Module"}));class ot extends _t{constructor(e,i,s,r,n,o,c,l,u){const f=o/c;let d,g;f>1?(d=l,g=Math.round(l/f)):(g=u,d=Math.round(u*f));super(e,i,s,r,o,c,d,g);a(this,"aa");this.aa=n}Fs(){super.Fs(),this.aa.pause(),this.aa.src="",this.aa.load()}ca(){if(this.aa.readyState>=this.aa.HAVE_CURRENT_DATA){const e=this.A;e.bindTexture(e.TEXTURE_2D,this.cn),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,this.aa),e.bindTexture(e.TEXTURE_2D,null)}}Fn(){return this.cn}lt(){return this.Z=null,super.lt()}xn(){this.ca()}static async Pn(e,i,s,r,n){const o=e.context;let c;c=document.createElement("video"),c.crossOrigin="anonymous",c.loop=!0,c.muted=!0,c.playsInline=!0,await new Promise((d,g)=>{c.addEventListener("loadedmetadata",()=>d(),{once:!0}),c.addEventListener("error",v=>{var m;const A=v.target;g(new Error(`Failed to load video: ${((m=A.error)==null?void 0:m.message)||"Unknown error"}`))},{once:!0}),c.src=s});const l=o.createTexture();o.bindTexture(o.TEXTURE_2D,l),o.pixelStorei(o.UNPACK_FLIP_Y_WEBGL,1),dt(o,o.LINEAR,o.LINEAR,o.CLAMP_TO_EDGE,o.CLAMP_TO_EDGE),o.texImage2D(o.TEXTURE_2D,0,o.RGBA,o.RGBA,o.UNSIGNED_BYTE,c),o.bindTexture(o.TEXTURE_2D,null);const u=c.videoWidth,f=c.videoHeight;return new ot(o,e,l,i,c,u,f,r,n)}async play(){await this.aa.play()}pause(){this.aa.pause()}stop(){this.aa.pause(),this.aa.currentTime=0}speed(e){return this.aa.playbackRate=e,this}loop(e=!0){return this.aa.loop=e,this}time(e){return this.aa.currentTime=e,this}volume(e){return this.aa.volume=Math.max(0,Math.min(1,e)),this}get videoElement(){return this.aa}get currentTime(){return this.aa.currentTime}get duration(){return this.aa.duration}get isPlaying(){return!this.aa.paused&&!this.aa.ended}}const Ke=h=>class extends h{la(t,e,i,s){if(C.rn(t))return t;if(typeof t=="number"||typeof t=="string")return this.color(t,e,i,s);throw new Error("Unsupported color input passed to color-capable method.")}rotate(t=0,e=0,i=0){this.K.state.Zt(t),this.K.state.qt(e),this.K.state.Vt(i)}rotateX(t){this.K.state.Zt(t)}rotateY(t){this.K.state.qt(t)}rotateZ(t){this.K.state.Vt(t)}translate(t=0,e=0,i=0){this.K.state.Jt(t,e,i)}translateX(t){this.K.state.Jt(t,0,0)}translateY(t){this.K.state.Jt(0,t,0)}translateZ(t){this.K.state.Jt(0,0,t)}push(){this.K.state.nt()}pop(){this.K.state.ot()}color(t,e,i,s){return C.en(t,e,i,s)}rect(t=1,e=1){this.K.bi(t,e)}point(){this.K.bi(1,1)}line(t,e,i,s){this.K.wi(t,e,i,s)}lineWeight(t){this.K.state.Wt(t)}background(t,e,i,s=255){const r=this.la(t,e,i,s);this.K.Pi(r.r,r.g,r.b,r.a)}char(t){const e=Array.from(t);if(e.length===0)throw new Error("char() requires at least one character.");this.K.state.rs(this.ua.font.Fr(e[0]))}charColor(t,e,i,s){const r=this.la(t,e,i,s);this.K.state.ns(r.r,r.g,r.b,r.a)}cellColor(t,e,i,s){const r=this.la(t,e,i,s);this.K.state.hs(r.r,r.g,r.b,r.a)}flipX(t){this.K.state.cs(t)}flipY(t){this.K.state.ls(t)}charRotation(t){this.K.state.fs(t)}invert(t){this.K.state.us(t)}clear(){this.K.ye(0,0,0,0)}ellipse(t,e){this.K.xi(t/2,e/2)}triangle(t,e,i,s,r,n){this.K.Mi(t,e,i,s,r,n)}bezierCurve(t,e,i,s,r,n,o,c){this.K.Ci(t,e,i,s,r,n,o,c)}arc(t,e,i,s){this.K.Fi(t/2,e/2,i,s)}shader(t){this.K.pi(t)}setUniform(t,e){this.K.H(t,e)}setUniforms(t){this.K.mi(t)}async createFilterShader(t){if(typeof t=="string"&&(t.startsWith("./")||t.startsWith("../")||t.endsWith(".frag")||t.endsWith(".glsl"))){const e=await fetch(t);if(!e.ok)throw new Error(`Failed to load shader from ${t}: ${e.statusText}`);const i=await e.text();return this.K.gi(i)}return this.K.gi(t)}async createShader(t,e){let i,s;if(typeof t=="string"&&(t.startsWith("./")||t.startsWith("../")||t.endsWith(".vert")||t.endsWith(".glsl"))){const r=await fetch(t);if(!r.ok)throw new Error(`Failed to load vertex shader from ${t}: ${r.statusText}`);i=await r.text()}else i=t;if(typeof e=="string"&&(e.startsWith("./")||e.startsWith("../")||e.endsWith(".frag")||e.endsWith(".glsl"))){const r=await fetch(e);if(!r.ok)throw new Error(`Failed to load fragment shader from ${e}: ${r.statusText}`);s=await r.text()}else s=e;return this.K.di(i,s)}createFramebuffer(t){return this.K.$i(t.width??this.grid.cols,t.height??this.grid.rows,t.attachments??3)}image(t,e,i){var s;this.K._i(t,e,i,((s=this.ua)==null?void 0:s.font)??this.fa.base.font),t instanceof B&&this.K.ht()}async loadImage(t){const e=t,i=await new Promise((s,r)=>{const n=new Image;n.crossOrigin="anonymous",n.onload=()=>s(n),n.onerror=o=>r(o),n.src=e});return J.Pn(this.K,this.pn,i,this.grid.cols,this.grid.rows)}async loadVideo(t){return await ot.Pn(this.K,this.pn,t,this.grid.cols,this.grid.rows)}},He=h=>class extends h{get frameCount(){return this.da.Kn}set frameCount(t){this.da.Kn=t}frameRate(t){return t===void 0?this.da.Wn:this.da.Qn(t,()=>this.va())}noLoop(){this.da.Gn()}loop(){this.da.jn(()=>this.va())}redraw(t=1){if(ft.m(typeof t=="number"&&t>0&&Number.isInteger(t),"Redraw count must be a positive integer.",{method:"redraw",providedValue:t}))for(let e=0;e<t;e++)this.va()}isLooping(){return this.da.Xn}millis(){return this.da.qn()}secs(){return this.da.Vn()}deltaTime(){return this.da.Jn}},je=h=>class extends h{constructor(...t){super(...t)}mouseClicked(t){this.sh.So(t)}mousePressed(t){this.sh.Ro(t)}mouseReleased(t){this.sh.Eo(t)}mouseMoved(t){this.sh.ko(t)}mouseScrolled(t){this.sh.Do(t)}get mouse(){return this.sh.Lo()}cursor(t){this.sh.bo(t)}},ke=h=>class extends h{constructor(...t){super(...t)}touchStarted(t){this.pa.jh(t)}touchMoved(t){this.pa.ko(t)}touchEnded(t){this.pa.Qh(t)}touchCancelled(t){this.pa.Yh(t)}tap(t){this.pa.Xh(t)}doubleTap(t){this.pa.Wh(t)}longPress(t){this.pa.Kh(t)}swipe(t){this.pa.Zh(t)}pinch(t){this.pa.qh(t)}rotateGesture(t){this.pa.Vh(t)}get touches(){return this.pa.Gh()}},We=h=>class extends h{constructor(...t){super(...t)}keyPressed(t){this.ma.Ro(t)}keyReleased(t){this.ma.Eo(t)}isKeyPressed(t){return this.ma.Wo(t)}get lastKeyPressed(){return this.ma.Zo()}get lastKeyReleased(){return this.ma.qo()}get pressedKeys(){return this.ma.Vo()}get modifierState(){return this.ma.Jo()}};class Yt{constructor(t){a(this,"ga");a(this,"_a",new Map);a(this,"ya",[]);a(this,"ba",new Map);a(this,"wa",new Map);a(this,"xa",new Map);a(this,"Ma",new Map);a(this,"Ca",new Map);a(this,"Ua",new Map);a(this,"Fa",new Map);a(this,"$a",new Map);this.ga=t}Pa(t){for(const e of t){if(this._a.has(e.name))return void console.warn(`[textmode.js] Plugin "${e.name}" is already installed.`);const i=this.Ta(e.name);try{const s=e.install(this.ga,i);s instanceof Promise&&s.catch(r=>{console.error(`[textmode.js] Async plugin "${e.name}" installation error:`,r),this.za(e.name)})}catch(s){throw this.za(e.name),s}this._a.set(e.name,e),this.ya.push(e.name)}}async Sa(t){for(const e of t){if(this._a.has(e.name))return void console.warn(`[textmode.js] Plugin "${e.name}" is already installed.`);const i=this.Ta(e.name);try{await e.install(this.ga,i)}catch(s){throw this.za(e.name),s}this._a.set(e.name,e),this.ya.push(e.name)}}async Ra(t){const e=this._a.get(t);if(!e)return;const i=this.Ta(t);e.uninstall&&await e.uninstall(this.ga,i),this._a.delete(t),this.ya.splice(this.ya.indexOf(t),1),this.za(t)}Ea(){this.ka(this.ba)}Da(){this.ka(this.wa)}La(t){this.Oa(this.xa,t)}Ha(t){this.Ba(this.Ma,t)}Ia(t){this.Ba(this.Ca,t)}async Na(){await this.Ga(this.Ua)}async ja(){await this.Ga(this.Fa)}async Qa(){const t=[...this._a.keys()];for(const e of t)await this.Ra(e)}Ta(t){const e=this.ga,i=this;return{get renderer(){return e.K},get canvas(){return e.Er},get layerManager(){return e.layers},get font(){return e.layers.base.font},get grid(){return e.layers.base.grid},get drawFramebuffer(){return e.layers.base.drawFramebuffer},get asciiFramebuffer(){return e.layers.base.asciiFramebuffer},registerPreDrawHook:s=>i.Ya(i.ba,t,s),registerPostDrawHook:s=>i.Ya(i.wa,t,s),registerLayerDisposedHook:s=>i.Ya(i.xa,t,s),registerLayerPreRenderHook:s=>i.Ya(i.Ma,t,s),registerLayerPostRenderHook:s=>i.Ya(i.Ca,t,s),registerPreSetupHook:s=>i.Ya(i.Ua,t,s),registerPostSetupHook:s=>i.Ya(i.Fa,t,s),extendLayer:(s,r)=>{i.Xa(t,s,r)},removeLayerExtension:s=>{i.Wa(t,s)}}}Ya(t,e,i){const s=t.get(e)??new Set;return s.add(i),t.set(e,s),()=>{const r=t.get(e);r&&(r.delete(i),r.size===0&&t.delete(e))}}za(t){this.ba.delete(t),this.wa.delete(t),this.xa.delete(t),this.Ma.delete(t),this.Ca.delete(t),this.Ua.delete(t),this.Fa.delete(t);const e=this.$a.get(t);if(e){for(const i of e.keys())this.Ka(i);this.$a.delete(t)}}ka(t){for(const e of this.ya){const i=t.get(e);i&&i.forEach(s=>s())}}Oa(t,e){for(const i of this.ya){const s=t.get(i);s&&s.forEach(r=>r(e))}}Ba(t,e){for(const i of this.ya){const s=t.get(i);s&&s.forEach(r=>r(e))}}async Ga(t){for(const e of this.ya){const i=t.get(e);if(i)for(const s of i)await s()}}Xa(t,e,i){let s=this.$a.get(t);s||(s=new Map,this.$a.set(t,s));for(const[r,n]of this.$a)r!==t&&n.has(e)&&console.warn(`[textmode.js] Plugin "${t}" is overwriting layer method "${e}" previously added by plugin "${r}".`);s.set(e,i),this.Za(e,i)}Wa(t,e){const i=this.$a.get(t);if(!i)return;i.delete(e);let s=!1;for(const[r,n]of this.$a)if(r!==t&&n.has(e)){s=!0;const o=n.get(e);this.Za(e,o);break}s||this.Ka(e)}Za(t,e){const i=Object.getPrototypeOf(this.ga.layers.base);Object.defineProperty(i,t,{value:e,writable:!0,configurable:!0,enumerable:!1})}Ka(t){const e=Object.getPrototypeOf(this.ga.layers.base),i=Object.getOwnPropertyDescriptor(e,t);i&&i.configurable&&delete e[t]}}const Qe=Object.freeze(Object.defineProperty({__proto__:null,TextmodePluginManager:Yt},Symbol.toStringTag,{value:"Module"}));class Xt{constructor(){a(this,"qa",new Map);a(this,"Va",[]);a(this,"Ja",0);a(this,"tc",0);a(this,"sc")}get ec(){return this.Ja}get rc(){if(this.Ja===0)return 0;let t=0;for(const e of this.Va){const i=this.qa.get(e);i&&(t+=Math.min(1,Math.max(0,i.progress))*i.weight)}return Math.min(1,t/this.Ja)}nc(t){this.sc=t}oc(t,e=1){const i=`phase-${this.Va.length+1}-${Date.now()}`,s={id:i,label:t,weight:Math.max(.001,e),progress:0,status:"running"};return this.qa.set(i,s),this.Va.push(i),this.Ja+=s.weight,i}hc(t,e){const i=this.qa.get(t);if(!i)return;i.progress=Math.max(0,Math.min(1,e)),i.status=i.progress>=1?"complete":"running";const s=this.rc;Math.abs(s-this.tc)>.001&&(this.tc=s,this.sc&&this.sc(s))}ac(t){const e=this.qa.get(t);e&&(e.progress=1,e.status="complete",this.hc(t,1))}cc(t){const e=this.qa.get(t);e&&(e.status="failed")}lc(){return this.Va.map(t=>{const e=this.qa.get(t);return e?{id:e.id,label:e.label,weight:e.weight,progress:e.progress,status:e.status}:{id:t,label:t,weight:1,progress:0,status:"pending"}})}}class Kt{constructor(t="active"){a(this,"uc");a(this,"fc","");a(this,"dc","");this.uc=t}get vc(){return this.uc}get mc(){return this.uc!=="disabled"}get gc(){return this.uc==="active"||this.uc==="transitioning"||this.uc==="error"}get _c(){return this.fc}get yc(){return this.dc}bc(){this.uc!=="done"&&this.uc!=="transitioning"||(this.uc="active")}wc(){this.uc!=="disabled"&&(this.uc="done")}xc(){this.uc!=="disabled"&&(this.uc="transitioning")}Mc(){this.uc==="transitioning"&&(this.uc="done")}Cc(t){this.uc!=="disabled"&&(this.uc="error",t instanceof Error?(this.fc=t.message,this.dc=t.stack||""):(this.fc=t,this.dc=""))}Uc(){this.uc="disabled"}}class Ht{constructor(t,e){a(this,"Fc",0);a(this,"$c",1);a(this,"Pc");a(this,"Tc");this.Pc=t,this.Tc=e}get zc(){return this.$c}get Sc(){return this.$c<1}In(){this.Pc!=="none"&&this.Tc>0&&(this.Fc=performance.now())}et(){if(this.Pc==="none"||this.Tc===0)return this.$c=1,!1;const t=performance.now()-this.Fc,e=Math.min(1,t/this.Tc);return e>=1?(this.$c=0,!0):(this.$c=1-e,!1)}Js(){this.$c=1,this.Fc=0}}function Et(h,t){const e=h.tone??"auto";let i="dark";return e==="light"||e==="dark"?i=e:t&&(i=function(s){if(!s)return 0;const[r,n,o]=s.map(l=>l/255),c=l=>l<=.04045?l/12.92:Math.pow((l+.055)/1.055,2.4);return .2126*c(r)+.7152*c(n)+.0722*c(o)}(t)>.5?"light":"dark"),{mode:i,background:t,textColor:i==="light"?"#1A1A1A":"#F8F8F8",subtleColor:i==="light"?"#4A4A4A":"#C0C0C0"}}function jt(h){return h.mode==="light"?["#E91E63","#9C27B0","#FF6F00"]:["#8EF9F3","#F15BB5","#FF9B71"]}function kt(h,t){return h.length?h.map(e=>t.color(e)):[t.color("#FFFFFF")]}class Wt{constructor(t,e,i,s){this.Rc=t,this.id=e,this.label=i,this.Ec=s}report(t){this.Rc.hc(this.id,t)}complete(){this.Rc.ac(this.id)}fail(t){this.Rc.cc(this.id),this.Ec&&this.Ec(t??new Error(`Loading phase "${this.label}" failed`))}async track(t){try{const e=typeof t=="function"?await t():await t;return this.complete(),e}catch(e){throw this.fail(e instanceof Error?e:String(e)),e}}}const Ve=({textmodifier:h,grid:t,progress:e,frameCount:i,message:s,palette:r,theme:n,phases:o,transitionOpacity:c,isError:l,errorMessage:u})=>{const f="|/-\\",d=Math.floor(i/6)%4,g=h.color(n.textColor),v=Math.floor(255*c),A=h.color(g.r,g.g,g.b,v);if(h.charColor(A),h.cellColor(0,0,0,0),l){const m=h.color(n.mode==="light"?"#D32F2F":"#FF6B6B",v);h.charColor(m),h.push(),h.translate(0,-2,0),h.char("X"),h.rect(1,1),h.pop();const b="SETUP ERROR",p=-Math.floor(b.length/2);h.push(),h.translate(p,0,0);for(const y of b)h.char(y),h.rect(1,1),h.translateX(1);if(h.pop(),u){const y=h.color(n.subtleColor),x=h.color(y.r,y.g,y.b,v);h.charColor(x);const E=Math.floor(.8*t.cols),F=u.split(" "),R=[];let M="";for(const I of F)(M+" "+I).length<=E?M=M?M+" "+I:I:(M&&R.push(M),M=I);M&&R.push(M);const D=R.slice(0,3);R.length>3&&(D[2]=D[2].substring(0,E-3)+"..."),D.forEach((I,lt)=>{const ci=-Math.floor(I.length/2);h.push(),h.translate(ci,3+lt,0);for(const li of I)h.char(li),h.rect(1,1),h.translateX(1);h.pop()})}return}if(h.push(),h.translate(0,0,0),h.char(f[d]),h.rect(1,1),h.pop(),e>0||o.some(m=>m.status!=="pending")){const m=Math.max(6,Math.floor(.6*t.cols)),b=-Math.floor(m/2),p=Math.floor(m*e),y=r.length?r:[h.color("#FFFFFF")];h.push(),h.translate(b,3,0);for(let x=0;x<m;x++){const E=x<p?"*":".",F=y[x%y.length],R=h.color(F.r,F.g,F.b,v);h.charColor(R),h.char(E),h.rect(1,1),h.translateX(1)}h.pop()}if(s){const m=h.color(n.subtleColor),b=h.color(m.r,m.g,m.b,v);h.charColor(b);const p=-Math.floor(s.length/2);h.push(),h.translate(p,5,0);for(const y of s)h.char(y),h.rect(1,1),h.translateX(1);h.pop()}};class ht{constructor(t,e={}){a(this,"kc");a(this,"zc");a(this,"Dc");a(this,"Lc");a(this,"Oc");a(this,"Hc");a(this,"Bc");a(this,"Ic");a(this,"Nc");a(this,"Gc");a(this,"rr");a(this,"jc");a(this,"Qc");a(this,"Yc");a(this,"Xc");a(this,"Wc",()=>{});a(this,"Kc",[]);a(this,"Zc",new Map);this.kc=e.visible??!0,this.zc=e.opacity??1,this.Dc=e.blendMode??"normal",this.Lc=e.offsetX??0,this.Oc=e.offsetY??0,this.Hc=e.rotationZ??0,this.Bc=e.fontSize??16,this.Ic=e.fontSource,e.fontSource instanceof rt?this.rr=e.fontSource:this.rr=new rt(t,this.Bc)}async qc(t){this.Nc=t,this.rr.Pr||await this.rr.Ar(this.Ic);const e=this.rr.maxGlyphDimensions;this.Gc=new Lt(this.Nc.canvas.canvas,e.width,e.height);const i=this.Gc;this.jc=this.Nc.createFramebuffer(i.cols,i.rows,3),this.Qc=this.Nc.createFramebuffer(i.width,i.height,1),this.Yc=this.Nc.createFramebuffer(i.width,i.height,1),this.Xc=[this.Nc.createFramebuffer(i.width,i.height,1,{depth:!1}),this.Nc.createFramebuffer(i.width,i.height,1,{depth:!1})],this.Gc.Br(()=>{var s,r,n;this.jc.resize(this.Gc.cols,this.Gc.rows),this.Qc.resize(this.Gc.width,this.Gc.height),(s=this.Yc)==null||s.resize(this.Gc.width,this.Gc.height),(r=this.Xc)==null||r[0].resize(this.Gc.width,this.Gc.height),(n=this.Xc)==null||n[1].resize(this.Gc.width,this.Gc.height)})}draw(t){this.Wc=t}show(){this.kc=!0}hide(){this.kc=!1}opacity(t){if(t===void 0)return this.zc;this.zc=Math.min(1,Math.max(0,t))}blendMode(t){if(t===void 0)return this.Dc;this.Dc=t}offset(t,e=0){if(t===void 0)return{x:this.Lc,y:this.Oc};this.Lc=t,this.Oc=e}rotateZ(t){if(t===void 0)return this.Hc;this.Hc=t}filter(t,e){this.Kc.push({name:t,params:e})}setPluginState(t,e){this.Zc.set(t,e)}getPluginState(t){return this.Zc.get(t)}hasPluginState(t){return this.Zc.has(t)}deletePluginState(t){return this.Zc.delete(t)}fontSize(t){ft.m(typeof t=="number"&&t>0,"Font size must be a positive number greater than 0.",{method:"fontSize",providedValue:t})&&this.rr.fontSize!==t&&(this.rr.Mr(t),this.Vc())}async loadFont(t){if(!this.rr)throw new Error("Layer font not initialized. Ensure layer is attached before loading fonts.");return t instanceof rt?(this.rr=t,this.rr.Pr||await this.rr.Ar()):await this.rr.Cr(t),this.Vc(),this.rr}va(t,e,i){if(!this.kc)return;const s=this.Nc.renderer,r=this.Gc;t.Jc.Ha(this),this.jc.begin(),s.state.Kt(),t.ua=this;try{this.Wc.call(t)}finally{t.ua=void 0}if(this.jc.end(),t.Jc.Ia(this),i==="2d"){const n=this.Kc.length>0,o=n?this.Yc:this.Qc;o.begin(),s.fi(e),e.O({u_characterTexture:this.rr.fontFramebuffer,u_charsetDimensions:[this.rr.textureColumns,this.rr.textureRows],Ud:this.jc.textures[0],Ue:this.jc.textures[1],Uf:this.jc.textures[2],Ug:[r.cols,r.rows],Uh:[o.width,o.height],Ui:[0,0,0,0]}),s.Ai(0,0,r.width,r.height),o.end(),n&&this.Nc.filterManager.tl(this.Yc.textures[0],this.Qc,this.Kc,this.Qc.width,this.Qc.height,this.Xc)}this.Kc=[]}Vr(){var t;this.jc&&this.Qc&&((t=this.Gc)==null||t.Js())}Fs(){var t,e,i,s,r,n,o;(t=this.jc)==null||t.dispose(),(e=this.Qc)==null||e.dispose(),(i=this.Yc)==null||i.dispose(),(s=this.Xc)==null||s[0].dispose(),(r=this.Xc)==null||r[1].dispose(),(n=this.rr)==null||n.Fs(),(o=this.Gc)==null||o.Fs()}get texture(){var t;return(t=this.Qc)==null?void 0:t.textures[0]}get grid(){return this.Gc}get font(){return this.rr}get width(){return this.Qc?this.Qc.width:0}get height(){return this.Qc?this.Qc.height:0}get drawFramebuffer(){return this.jc}get asciiFramebuffer(){return this.Qc}Vc(){if(!this.Gc||!this.rr)return;const t=this.rr.maxGlyphDimensions;this.Gc.Nr(t.width,t.height),this.jc&&this.Qc&&this.Vr()}}const L=`#version 300 es
layout(location=0)in vec2 A;layout(location=1)in vec2 B;out vec2 v_uv;void main(){v_uv=B;gl_Position=vec4(A,0.,1.);}`,Qt=`#version 300 es
precision highp float;uniform sampler2D u_characterTexture;uniform vec2 u_charsetDimensions;uniform sampler2D Ue;uniform sampler2D Uf;uniform sampler2D Ud;uniform vec2 Ug;uniform vec2 Uh;uniform vec4 Ui;in vec2 v_uv;out vec4 fragColor;mat2 A(float B){float C=sin(B);float D=cos(B);return mat2(D,-C,C,D);}void main(){vec2 E=gl_FragCoord.xy/Uh;vec2 F=E*Ug;vec2 G=floor(F);vec2 H=(G+0.5)/Ug;vec4 I=texture(Ue,H);vec4 J=texture(Uf,H);vec4 K=texture(Ud,H);int L=int(K.b*255.+0.5);bool M=(L&1)!=0;bool N=(L&2)!=0;bool O=(L&4)!=0;int P=int(K.r*255.+0.5)+int(K.g*255.+0.5)*256;int Q=int(u_charsetDimensions.x);int R=P/Q;int S=P-(R*Q);float T=(u_charsetDimensions.y-1.)-float(R);vec2 U=1./u_charsetDimensions;vec2 V=vec2(float(S),T)*U;vec2 W=V+U;float X=-K.a*360.*0.017453292;vec2 Y=fract(F)-0.5f;vec2 Z=vec2(N?-1.:1.,O?-1.:1.);Y*=Z;Y=A(X)*Y+0.5;vec2 a=V+clamp(Y,0.,1.)*U;const float b=0.0001;if(any(lessThan(a,V-b))||any(greaterThan(a,W+b))){fragColor=M?I:J;return;}vec4 c=texture(u_characterTexture,a);if(M)c.rgb=mix(c.rgb,1.-c.rgb,float(M));vec4 d=mix(Ui,J,J.a);fragColor=mix(d,I,c);}`,bt=`#version 300 es
precision highp float;uniform sampler2D u_texture;in vec2 v_uv;out vec4 fragColor;void main(){fragColor=texture(u_texture,v_uv);}`,Ze={message:"LOADING...",tone:"auto",transition:"fade",transitionDuration:500};class Vt{constructor(t,e,i){a(this,"ga");a(this,"l");a(this,"sl");a(this,"Rc");a(this,"el");a(this,"il");a(this,"rl");a(this,"nl");a(this,"ol",[]);a(this,"hl");a(this,"al",performance.now());a(this,"cl",0);a(this,"ll",!1);a(this,"yr",!1);a(this,"vl");this.ga=t,this.l={...Ze,...e??{}},this.sl=new Kt("active"),this.Rc=new Xt,this.el=new Ht(this.l.transition,this.l.transitionDuration),this.il=new zt(60),this.hl=Et(this.l,i);const s=jt(this.hl);this.ol=kt(s,this.ga),this.nl=this.ul(),this.Rc.nc(r=>{r>=.999&&this.wc()})}async Ar(){if(this.yr)return;const t=this.ga.K,e=this.ga.Er;this.rl=new ht(t,{visible:!0,opacity:1,fontSize:16}),await this.rl.qc({renderer:t,canvas:e,filterManager:null,createFramebuffer:(i,s,r=1,n)=>t.$i(i,s,r,n)}),this.yr=!0}get gc(){return this.sl.gc&&this.ll}In(){this.ll||(this.ll=!0,this.al=performance.now(),this.cl=0,this.il.In(()=>this.fl()))}Nn(){this.ll&&(this.ll=!1,this.il.Nn())}Vr(){this.yr&&this.rl.Vr()}Fs(){this.Nn(),this.yr&&(this.rl.Fs(),this.yr=!1)}get progress(){return this.Rc.rc}message(t){return typeof t=="string"&&(this.l.message=t),this.l.message}addPhase(t,e=1){this.sl.bc();const i=this.Rc.oc(t,e);return new Wt(this.Rc,i,t,s=>this.error(s))}wc(){this.sl.vc!=="error"&&(this.l.transition!=="none"&&this.l.transitionDuration>0?(this.sl.xc(),this.el.In()):(this.sl.wc(),this.Nn(),this.dl()))}dl(){this.vl&&this.vl()}pl(t){this.vl=t}error(t){this.sl.Cc(t)}fl(){if(this.sl.gc){if(this.cl++,this.sl.vc==="transitioning"&&this.el.et())return this.sl.Mc(),this.dl(),void this.Nn();this.ml()}}ml(){if(!this.yr)return;const t=this.rl,e=t.grid,i=this.ga.K,s=this.ga.K.di(L,Qt),r=this.ga.K.di(L,bt),n={textmodifier:this.ga,grid:e,progress:this.progress,elapsedMs:performance.now()-this.al,frameCount:this.cl,message:this.l.message,palette:this.ol,theme:this.hl,phases:this.Rc.lc(),transitionOpacity:this.el.zc,isError:this.sl.vc==="error",errorMessage:this.sl._c||void 0,errorDetails:this.sl.yc||void 0};t.draw(()=>{this.ga.clear(),this.ga.push();try{this.nl(n)}finally{this.ga.pop()}}),t.va(this.ga,s,"2d");const o=t.texture;o&&(i.ye(...i.state.canvasBackgroundColor),i.fi(r),r.O({u_texture:o}),i.Ai(e.offsetX,e.offsetY,e.width,e.height))}_l(t){this.hl=Et(this.l,t)}ul(){const t=this.l.renderer||Ve;return e=>{t(e),this.yl(e)}}yl(t){const{textmodifier:e,grid:i,frameCount:s,theme:r,transitionOpacity:n}=t,o=[116,101,120,116,109,111,100,101,46,106,115].map(f=>String.fromCharCode(f)).join(""),c=(i.rows+1>>1)-2,l=2-(i.cols+1>>1),u=r.mode==="light"?[[233,30,99],[156,39,176],[255,111,0]]:[[142,249,243],[241,91,181],[255,155,113]];e.push(),e.translate(l,c,0);for(let f=0;f<o.length;f++){const d=o[f],g=Math.floor(.1*s+.5*f)%u.length,[v,A,m]=u[g],b=Math.floor(255*n),p=e.color(v,A,m,b);e.charColor(p),e.char(d),e.point(),e.translateX(1)}e.pop()}}const Zt={normal:0,additive:1,multiply:2,screen:3,subtract:4,darken:5,lighten:6,overlay:7,softLight:8,hardLight:9,colorDodge:10,colorBurn:11,difference:12,exclusion:13};class qt{constructor(t,e,i){a(this,"K");a(this,"Al");a(this,"Xc");a(this,"bl",0);this.K=t,this.Al=t.di(L,`#version 300 es
precision highp float;uniform sampler2D Uj;uniform sampler2D Uk;uniform vec2 Ul;uniform vec2 Um;uniform vec2 Un;uniform float Uo;uniform float Up;uniform int Uq;in vec2 v_uv;out vec4 fragColor;const int A=0;const int B=1;const int C=2;const int D=3;const int E=4;const int F=5;const int G=6;const int H=7;const int I=8;const int J=9;const int K=10;const int L=11;const int M=12;const int N=13;vec3 O(vec3 P,vec3 Q){return Q;}vec3 R(vec3 P,vec3 Q){return P+Q;}vec3 S(vec3 P,vec3 Q){return P*Q;}vec3 T(vec3 P,vec3 Q){return 1.-(1.-P)*(1.-Q);}vec3 U(vec3 P,vec3 Q){return max(P-Q,0.);}vec3 V(vec3 P,vec3 Q){return min(P,Q);}vec3 W(vec3 P,vec3 Q){return max(P,Q);}vec3 X(vec3 P,vec3 Q){return mix(2.*P*Q,1.-2.*(1.-P)*(1.-Q),step(0.5,P));}vec3 Y(vec3 P,vec3 Q){return mix(P-(1.-2.*Q)*P*(1.-P),mix(P+(2.*Q-1.)*(P*(3.-2.*P)-P),P+(2.*Q-1.)*(sqrt(P)-P),step(0.25,P)),step(0.5,Q));}vec3 Z(vec3 P,vec3 Q){return mix(2.*P*Q,1.-2.*(1.-P)*(1.-Q),step(0.5,Q));}vec3 a(vec3 P,vec3 Q){return mix(min(vec3(1.),P/max(1.-Q,0.0001)),vec3(1.),step(1.,Q));}vec3 b(vec3 P,vec3 Q){return mix(1.-min(vec3(1.),(1.-P)/max(Q,0.0001)),vec3(0.),step(Q,vec3(0.)));}vec3 c(vec3 P,vec3 Q){return abs(P-Q);}vec3 d(vec3 P,vec3 Q){return P+Q-2.*P*Q;}vec3 e(int f,vec3 P,vec3 Q){if(f==A)return O(P,Q);if(f==B)return R(P,Q);if(f==C)return S(P,Q);if(f==D)return T(P,Q);if(f==E)return U(P,Q);if(f==F)return V(P,Q);if(f==G)return W(P,Q);if(f==H)return X(P,Q);if(f==I)return Y(P,Q);if(f==J)return Z(P,Q);if(f==K)return a(P,Q);if(f==L)return b(P,Q);if(f==M)return c(P,Q);if(f==N)return d(P,Q);return O(P,Q);}void main(){vec4 g=texture(Uk,v_uv);vec2 h=v_uv*Ul;vec2 i=h-Un;vec2 j=Um*0.5;vec2 k=i-j;float l=cos(-Up);float m=sin(-Up);vec2 n=vec2(k.x*l-k.y*m,k.x*m+k.y*l);i=n+j;bool o=any(lessThan(i,vec2(0.)))||any(greaterThanEqual(i,Um));if(o){fragColor=g;return;}vec2 p=(floor(i)+0.5)/Um;vec4 q=texture(Uj,p);float r=q.a*Uo;if(r<=0.){fragColor=g;return;}vec3 s=e(Uq,g.rgb,q.rgb);vec3 t=mix(g.rgb,s,r);float u=g.a+r*(1.-g.a);fragColor=vec4(t,u);}`),this.Xc=[this.K.$i(e,i,1),this.K.$i(e,i,1)]}wl(t){const e=this.K.context,{base:i,targetFramebuffer:s,backgroundColor:r,layers:n,canvasWidth:o,canvasHeight:c}=t,l=e.isEnabled(e.DEPTH_TEST),u=e.getParameter(e.DEPTH_WRITEMASK);l&&e.disable(e.DEPTH_TEST),u&&e.depthMask(!1);const f=this.Xc[0];f.begin(),this.K.ye(...r),f.end(),this.bl=0,i.layer.kc&&this.xl(i.texture,o,c,i.width,i.height,i.layer.zc,i.offsetX,i.offsetY,i.layer.Hc,"normal");for(const d of n){const g=d.layer;g.kc&&this.xl(d.texture,o,c,d.width,d.height,g.zc,d.offsetX,d.offsetY,g.Hc,g.Dc)}this.Ml(s,o,c),e.depthMask(u),l&&e.enable(e.DEPTH_TEST)}xl(t,e,i,s,r,n,o,c,l,u){const f=this.Xc[this.bl],d=this.bl===0?1:0,g=this.Xc[d],v=l*(Math.PI/180);g.begin(),this.K.fi(this.Al),this.Al.O({Uj:t,Uk:f.textures[0],Ul:[e,i],Um:[s,r],Un:[o,c],Uo:n,Up:v,Uq:Zt[u]}),this.K.Ai(0,0,f.width,f.height),g.end(),this.bl=d}Ml(t,e,i){const s=this.Xc[this.bl];t.begin(),this.K.fi(this.Al),this.Al.O({Uj:s.textures[0],Uk:s.textures[0],Ul:[e,i],Um:[s.width,s.height],Un:[0,0],Uo:1,Up:0,Uq:Zt.normal}),this.K.Ai(0,0,e,i),t.end()}Vr(t,e){this.Xc[0].resize(t,e),this.Xc[1].resize(t,e)}Fs(){this.Al.dispose(),this.Xc[0].dispose(),this.Xc[1].dispose()}}const j={right:[1,0,0],left:[-1,0,0],top:[0,1,0],bottom:[0,-1,0],front:[0,0,1],back:[0,0,-1]};class Jt{constructor(t){a(this,"K");a(this,"Cl");a(this,"Fl");a(this,"$l",null);a(this,"Pl",null);a(this,"Tl",null);a(this,"zl",null);a(this,"Sl",0);a(this,"Rl",0);a(this,"El",0);a(this,"kl",0);a(this,"Dl",0);this.K=t,this.Cl=t.di(L,`#version 300 es
precision highp float;const float A=0.001f;const int B=256;in vec2 v_uv;layout(location=0)out vec4 C;layout(location=1)out vec4 D;uniform vec2 u_resolution;uniform float Ur;uniform vec3 Us;uniform vec2 Uh;uniform vec3 Uw;uniform mat3 Ux;uniform float Uv;uniform vec3 Ut;uniform int Uu;uniform sampler2D Ud;vec2 E(vec3 F){float G=Us.y*max(1.0f,Us.z);vec2 H;H.x=(Us.x-(F.x+0.5f+A*0.1f))/Us.x;H.y=((F.y+(Us.z-1.0f-F.z)*Us.y)+0.5f+A*0.1f)/G;return vec2(H.x,1.0f-H.y);}bool I(vec3 F){if(F.x<0.0f||F.x>=Us.x||F.y<0.0f||F.y>=Us.y||F.z<0.0f||F.z>=Us.z){return false;}if(Uu!=-1&&int(F.z+0.5f)!=Uu){return false;}vec2 H=E(F);vec4 J=texture(Ud,H);return!(J.r>=1.0f&&J.g>=1.0f);}float K(vec3 L,vec3 M){vec3 N=L-M;vec3 O=Ut*0.5f;vec3 P=abs(N)/O;if(P.x>P.y&&P.x>P.z){return N.x>0.0f?0.0f:1.0f;}else if(P.y>P.z){return N.y>0.0f?2.0f:3.0f;}else{return N.z>0.0f?4.0f:5.0f;}}vec2 Q(vec3 L,vec3 M,float R){vec3 S=L-M;vec2 T;vec2 U;int V=int(R+0.5f);if(V==2||V==3){U=vec2(Ut.x,Ut.z);T=(V==2)?vec2(S.x,S.z):vec2(S.x,-S.z);}else if(V==0||V==1){U=vec2(Ut.y,Ut.z);T=(V==0)?vec2(S.z,S.y):vec2(-S.z,S.y);}else{U=vec2(Ut.x,Ut.y);T=(V==4)?vec2(-S.x,S.y):vec2(S.x,S.y);}return 1.0f-(T/U+0.5f);}struct W{bool X;vec3 F;vec3 M;float Y;};W Z(vec3 a,vec3 b){W c;c.X=false;vec3 d=(Us*Ut)*0.5f;vec3 e=-d;vec3 f=d;vec3 g=1.0f/b;vec3 h=(e-a)*g;vec3 i=(f-a)*g;vec3 j=min(h,i);vec3 k=max(h,i);float l=max(max(j.x,j.y),j.z);float m=min(min(k.x,k.y),k.z);if(m<max(l,0.0f)){return c;}l=max(l,0.0f);vec3 n=a+l*b+b*A;vec3 o=d;float p=floor((n.x+o.x)/Ut.x+A*0.1f);float q=floor((n.y+o.y)/Ut.y+A*0.1f);float r=floor((n.z+o.z)/Ut.z+A*0.1f);vec3 s=abs(b);vec3 step=vec3(b.x>0.0f?1.0f:-1.0f,b.y>0.0f?1.0f:-1.0f,b.z>0.0f?1.0f:-1.0f);float t=(s.x<A)?1e10f:Ut.x/s.x;float u=(s.y<A)?1e10f:Ut.y/s.y;float v=(s.z<A)?1e10f:Ut.z/s.z;vec3 F=vec3(p,q,r);vec3 M=-d+(F+vec3(0.5f))*Ut;float w=(b.x>0.0f)?(M.x+Ut.x*0.5f):(M.x-Ut.x*0.5f);float x=(b.y>0.0f)?(M.y+Ut.y*0.5f):(M.y-Ut.y*0.5f);float y=(b.z>0.0f)?(M.z+Ut.z*0.5f):(M.z-Ut.z*0.5f);float z=(abs(b.x)<A)?1e10f:(w-n.x)/b.x;float AA=(abs(b.y)<A)?1e10f:(x-n.y)/b.y;float AB=(abs(b.z)<A)?1e10f:(y-n.z)/b.z;for(int AC=0;AC<B;AC++){if(I(F)){c.M=-d+(F+vec3(0.5f))*Ut;vec3 AD=c.M-Ut*0.5f;vec3 AE=c.M+Ut*0.5f;vec3 AF=(AD-a)*g;vec3 AG=(AE-a)*g;vec3 AH=min(AF,AG);c.Y=max(max(AH.x,AH.y),max(AH.z,0.0f));c.F=F;c.X=true;return c;}if(z<=AA&&z<=AB){p+=step.x;z+=t;F.x=p;}else if(AA<=AB){q+=step.y;AA+=u;F.y=q;}else{r+=step.z;AB+=v;F.z=r;}float AI=min(min(z,AA),AB);if(AI>m){break;}}return c;}void main(){vec3 d=(Us*Ut)*0.5f;float AJ=max(Uv,0.0001f);vec2 AK=vec2(Us.x,Us.y);vec2 AL=AK*0.5f;vec2 AM=gl_FragCoord.xy/max(Ur,0.0001f);vec2 AN=u_resolution;vec2 AO=Uh;vec2 AP=(AN-AO)*0.5f;vec2 AQ=AM-AP;vec2 AR=AQ/AO;vec2 AS=1.0f-AR;if(any(lessThan(AS,vec2(0.0f)))||any(greaterThan(AS,vec2(1.0f)))){C=vec4(0.0f);D=vec4(0.0f);return;}vec2 AT=clamp(AS,0.0f,1.0f);vec2 AU=AL+((AT*AK)-AL)/AJ;vec2 AV=vec2(Ut.x,Ut.y);vec2 AW=(AU-AL);vec2 AX=AW*AV;float AY=length(Us*Ut);vec3 AZ=vec3(AX,-AY);const vec3 Aa=vec3(0.0f,0.0f,1.0f);mat3 Ab=Ux;vec3 Ac=Ab*(AZ-Uw);vec3 Ad=normalize(Ab*Aa);W c=Z(Ac,Ad);if(c.X){vec3 L=Ac+c.Y*Ad;float R=K(L,c.M);vec2 Ae=Q(L,c.M,R);vec3 Af=c.F/255.0f;C=vec4(Af,1.0f);D=vec4(Ae,R/5.0f,0.0f);}else{C=vec4(0.0f,0.0f,0.0f,0.0f);D=vec4(0.0f);}}`),this.Fl=t.di(L,`#version 300 es
precision highp float;const float A=0.001f;const float B=0.0001f;in vec2 v_uv;out vec4 fragColor;uniform sampler2D Uy;uniform sampler2D Uz;uniform sampler2D u_characterTexture;uniform vec2 u_charsetDimensions;uniform sampler2D Ue;uniform sampler2D Uf;uniform sampler2D Ud;uniform vec4 Ui;uniform vec3 Us;uniform vec3 UA;uniform vec3 UB;uniform vec3 UC;uniform vec3 UD;uniform vec3 UE;uniform vec3 UF;mat2 C(float D){float E=sin(D);float F=cos(D);return mat2(F,-E,E,F);}vec2 G(vec3 H){float I=Us.y*max(1.0f,Us.z);vec2 J;J.x=(Us.x-(H.x+0.5f+A*0.1f))/Us.x;J.y=((H.y+(Us.z-1.0f-H.z)*Us.y)+0.5f+A*0.1f)/I;return vec2(J.x,1.0f-J.y);}vec4 K(vec4 L,vec4 M,vec4 N,vec2 O,int P){int Q=int(L.b*255.0f+0.5f);bool R=(Q&1)!=0;bool S=(Q&2)!=0;bool T=(Q&4)!=0;int U=max(1,int(u_charsetDimensions.x));int V=P/U;int W=P-(V*U);float X=(u_charsetDimensions.y-1.0f)-float(V);vec2 Y=1.0f/u_charsetDimensions;vec2 Z=vec2(float(W),X)*Y;vec2 a=Z+Y;float b=-L.a*360.0f*0.017453292f;vec2 c=O-0.5f;vec2 d=vec2(S?-1.0f:1.0f,T?-1.0f:1.0f);c*=d;c=C(b)*c+0.5f;vec2 e=Z+clamp(c,0.0f,1.0f)*Y;if(any(lessThan(e,Z-B))||any(greaterThan(e,a+B))){return R?M:N;}vec4 f=texture(u_characterTexture,e);if(R){f.rgb=1.0f-f.rgb;}vec4 g=mix(Ui,N,N.a);return mix(g,M,f);}vec4 h(vec2 i){vec4 j=texture(Uy,i);vec4 k=texture(Uz,i);float l=j.w;if(l<0.5f){return Ui;}vec3 H=floor(j.xyz*255.0f+0.5f);vec2 O=k.xy;vec2 J=G(H);vec4 L=texture(Ud,J);vec4 M=texture(Ue,J);vec4 N=texture(Uf,J);int P=int(L.r*255.0f+0.5f)+int(L.g*255.0f+0.5f)*256;return K(L,M,N,O,P);}void main(){vec2 i=gl_FragCoord.xy/vec2(textureSize(Uy,0));fragColor=h(i);}`)}Ar(t,e,i=1){const s=e*Math.max(1,i);this.$l=this.K.$i(t,s,1),this.Pl=this.K.$i(t,s,1),this.Tl=this.K.$i(t,s,1),this.kl=t,this.Dl=e,this.Sl=i}Vr(t,e,i){var n,o,c;const s=i??this.Sl,r=e*Math.max(1,s);(n=this.$l)==null||n.resize(t,r),(o=this.Pl)==null||o.resize(t,r),(c=this.Tl)==null||c.resize(t,r),this.kl=t,this.Dl=e,this.Sl=s}wl(t){const e=this.K.context,{baseDrawFramebuffer:i,targetFramebuffer:s,backgroundColor:r,baseLayer:n,layers:o,font:c,grid:l,canvasWidth:u,canvasHeight:f,options3D:d={}}=t,g=[];if(n.kc){const E=n.grid;E&&g.push({framebuffer:i,cols:E.cols,rows:E.rows,cellWidth:E.cellWidth||1,cellHeight:E.cellHeight||1})}for(const E of o)if(E.kc){const F=E.drawFramebuffer,R=E.grid;F&&R&&g.push({framebuffer:F,cols:R.cols,rows:R.rows,cellWidth:R.cellWidth||1,cellHeight:R.cellHeight||1})}if(g.length===0)return s.begin(),this.K.ye(...r),void s.end();let v=0,A=0,m=0,b=0;for(const E of g)v=Math.max(v,E.cols),A=Math.max(A,E.rows),m=Math.max(m,E.cellWidth),b=Math.max(b,E.cellHeight);const p=g.length;v===this.kl&&A===this.Dl&&p===this.Sl||this.Vr(v,A,p);const y=e.isEnabled(e.DEPTH_TEST),x=e.getParameter(e.DEPTH_WRITEMASK);y&&e.disable(e.DEPTH_TEST),x&&e.depthMask(!1),this.Ll(g,e),this.Ol(s,p,c,l,r,u,f,d),e.depthMask(x),y&&e.enable(e.DEPTH_TEST)}Ll(t,e){const i=t.length;this.$l.begin(),this.K.ye(1,1,1,1),this.$l.end(),this.Pl.begin(),this.K.ye(0,0,0,0),this.Pl.end(),this.Tl.begin(),this.K.ye(0,0,0,0),this.Tl.end();for(let s=0;s<i;s++){const r=t[s],n=r.framebuffer,o=Math.floor((this.kl-r.cols)/2),c=s*this.Dl+Math.floor((this.Dl-r.rows)/2);this.Hl(n.textures[0],this.$l,r.cols,r.rows,o,c,e),this.Hl(n.textures[1],this.Pl,r.cols,r.rows,o,c,e),this.Hl(n.textures[2],this.Tl,r.cols,r.rows,o,c,e)}}Hl(t,e,i,s,r,n,o){const c=o.createFramebuffer();o.bindFramebuffer(o.READ_FRAMEBUFFER,c),o.framebufferTexture2D(o.READ_FRAMEBUFFER,o.COLOR_ATTACHMENT0,o.TEXTURE_2D,t,0);const l=e.j;o.bindFramebuffer(o.DRAW_FRAMEBUFFER,l);const u=e.height,f=s,d=u-n-s,g=u-n;o.blitFramebuffer(0,0,i,f,r,d,r+i,g,o.COLOR_BUFFER_BIT,o.NEAREST),o.bindFramebuffer(o.READ_FRAMEBUFFER,null),o.bindFramebuffer(o.DRAW_FRAMEBUFFER,null),o.deleteFramebuffer(c)}Ol(t,e,i,s,r,n,o,c){this.Bl(n,o);const l=[s.cellWidth,s.cellHeight,Math.max(s.cellWidth,s.cellHeight)];let u,f,d;const g=c.camera.getShaderUniforms();u=g.rotation,f=g.translation,d=g.zoom;const v=c.normals??{};this.zl.begin(),this.K.ye(0,0,0,0),this.K.fi(this.Cl),this.Cl.O({u_resolution:[n,o],Ur:1,Uh:[s.width,s.height],Us:[s.cols,s.rows,e],Ut:l,Ud:this.$l.textures[0],Uu:c.isolatedLayer??-1,Uv:d,Uw:f,Ux:u}),this.K.Ai(0,0,n,o),this.zl.end(),t.begin(),this.K.fi(this.Fl),this.Fl.O({Uy:this.zl.textures[0],Uz:this.zl.textures[1],u_characterTexture:i.fontFramebuffer,u_charsetDimensions:[i.textureColumns,i.textureRows],Ud:this.$l.textures[0],Ue:this.Pl.textures[0],Uf:this.Tl.textures[0],Us:[s.cols,s.rows,e],Ui:r,UA:v.right??j.right,UB:v.left??j.left,UC:v.top??j.top,UD:v.bottom??j.bottom,UE:v.front??j.front,UF:v.back??j.back}),this.K.Ai(0,0,n,o),t.end()}Bl(t,e){this.zl?this.Rl===t&&this.El===e||(this.zl.resize(t,e),this.Rl=t,this.El=e):(this.zl=this.K.$i(t,e,2,{depth:!1}),this.Rl=t,this.El=e)}Fs(){var t,e,i,s;this.Cl.dispose(),this.Fl.dispose(),(t=this.$l)==null||t.dispose(),(e=this.Pl)==null||e.dispose(),(i=this.Tl)==null||i.dispose(),(s=this.zl)==null||s.dispose(),this.$l=null,this.Pl=null,this.Tl=null,this.zl=null}get Il(){return this.kl}get Nl(){return this.Dl}}function $t(h,t){const e=[0,0,0,0,0,0,0,0,0];for(let i=0;i<3;i++)for(let s=0;s<3;s++){let r=0;for(let n=0;n<3;n++)r+=h[3*i+n]*t[3*n+s];e[3*i+s]=r}return e}function qe(h,t,e){const i=function(n){const o=Math.cos(n),c=Math.sin(n);return[1,0,0,0,o,-c,0,c,o]}(h),s=function(n){const o=Math.cos(n),c=Math.sin(n);return[o,0,c,0,1,0,-c,0,o]}(t),r=$t(function(n){const o=Math.cos(n),c=Math.sin(n);return[o,-c,0,c,o,0,0,0,1]}(e),s);return $t(r,i)}class at{constructor(t={}){a(this,"ks",[0,0,0]);a(this,"Es",[0,0,0]);a(this,"Gl",1);a(this,"jl",null);t.rotation&&(this.ks=[...t.rotation]),t.translation&&(this.Es=[...t.translation]),t.zoom!==void 0&&(this.Gl=Math.max(.001,t.zoom))}rotation(t,e,i){if(t===void 0)return[...this.ks];this.ks=[t,e??0,i??0],this.Ql()}rotateX(t){if(t===void 0)return this.ks[0];this.ks[0]=t,this.Ql()}rotateY(t){if(t===void 0)return this.ks[1];this.ks[1]=t,this.Ql()}rotateZ(t){if(t===void 0)return this.ks[2];this.ks[2]=t,this.Ql()}translation(t,e,i){if(t===void 0)return[...this.Es];this.Es=[t,e??0,i??0]}translateX(t){if(t===void 0)return this.Es[0];this.Es[0]=t}translateY(t){if(t===void 0)return this.Es[1];this.Es[1]=t}translateZ(t){if(t===void 0)return this.Es[2];this.Es[2]=t}zoom(t){if(t===void 0)return this.Gl;this.Gl=Math.max(.001,t)}reset(){this.ks=[0,0,0],this.Es=[0,0,0],this.Gl=1,this.Ql()}copyFrom(t){const e=t.rotation(),i=t.translation(),s=t.zoom();this.ks=[...e],this.Es=[...i],this.Gl=s,this.Ql()}clone(){return new at({rotation:[...this.ks],translation:[...this.Es],zoom:this.Gl})}getRotationMatrix(){return this.jl===null&&(this.jl=function(t,e,i){const s=Math.PI/180,r=qe(t*s,e*s,i*s),n=[(o=r)[0],o[3],o[6],o[1],o[4],o[7],o[2],o[5],o[8]];var o;return new Float32Array(n)}(this.ks[0],this.ks[1],this.ks[2])),this.jl}getShaderUniforms(){return{rotation:this.getRotationMatrix(),translation:this.Es,zoom:this.Gl}}Ql(){this.jl=null}}class Je{constructor(t={}){a(this,"Yl",[]);a(this,"Xl",[]);a(this,"Wl",!1);a(this,"l");this.l=t}async initialize(t){var e,i;for(const s of this.Xl)t&&await t(s),this.Yl.push(s),(i=(e=this.l).onAdd)==null||i.call(e,s);this.Xl=[],this.Wl=!0}get isReady(){return this.Wl}add(t){var e,i;return this.Wl?(this.Yl.push(t),(i=(e=this.l).onAdd)==null||i.call(e,t)):this.Xl.push(t),t}addMany(t){for(const e of t)this.add(e);return t}remove(t){const e=this.Yl.indexOf(t);if(e!==-1)return this.Yl.splice(e,1),this.Kl(t),!0;const i=this.Xl.indexOf(t);return i!==-1&&(this.Xl.splice(i,1),this.Kl(t),!0)}removeAt(t){if(t<0||t>=this.Yl.length)return;const[e]=this.Yl.splice(t,1);return this.Kl(e),e}move(t,e){var r,n;const i=this.Yl.indexOf(t);if(i!==-1){this.Yl.splice(i,1);const o=Math.max(0,Math.min(this.Yl.length,e));return this.Yl.splice(o,0,t),(n=(r=this.l).onMove)==null||n.call(r,t,i,o),!0}const s=this.Xl.indexOf(t);if(s!==-1){this.Xl.splice(s,1);const o=Math.max(0,Math.min(this.Xl.length,e));return this.Xl.splice(o,0,t),!0}return!1}swap(t,e){var o,c;if(t===e)return!0;const i=this.Yl.indexOf(t),s=this.Yl.indexOf(e);if(i!==-1&&s!==-1)return this.Yl[i]=e,this.Yl[s]=t,(c=(o=this.l).onSwap)==null||c.call(o,t,e,i,s),!0;const r=this.Xl.indexOf(t),n=this.Xl.indexOf(e);return r!==-1&&n!==-1&&(this.Xl[r]=e,this.Xl[n]=t,!0)}clear(){for(const t of this.Yl)this.Kl(t);this.Yl=[];for(const t of this.Xl)this.Kl(t);this.Xl=[]}dispose(){this.clear(),this.Wl=!1}get all(){return this.Yl}get pending(){return this.Xl}get length(){return this.Yl.length}get totalLength(){return this.Yl.length+this.Xl.length}get isEmpty(){return this.Yl.length===0}get(t){return this.Yl[t]}get first(){return this.Yl[0]}get last(){return this.Yl[this.Yl.length-1]}indexOf(t){return this.Yl.indexOf(t)}has(t){return this.Yl.includes(t)||this.Xl.includes(t)}[Symbol.iterator](){return this.Yl[Symbol.iterator]()}forEach(t){this.Yl.forEach(t)}map(t){return this.Yl.map(t)}filter(t){return this.Yl.filter(t)}find(t){return this.Yl.find(t)}findIndex(t){return this.Yl.findIndex(t)}some(t){return this.Yl.some(t)}every(t){return this.Yl.every(t)}reduce(t,e){return this.Yl.reduce(t,e)}Kl(t){var e,i,s,r;(i=(e=this.l).onRemove)==null||i.call(e,t),(r=(s=this.l).onDispose)==null||r.call(s,t)}}class te{constructor(t){a(this,"K");a(this,"Zl",new Map);a(this,"ql",new Map);this.K=t,this.Vl()}async Jl(t,e,i={}){const s=Object.entries(i),r=s.length>0?s[0][1][0]:null;let n;if(typeof e=="string"){let c=e;if(e.startsWith("./")||e.startsWith("../")||e.endsWith(".frag")||e.endsWith(".glsl")){const l=await fetch(e);if(!l.ok)throw new Error(`Failed to load shader from ${e}: ${l.statusText}`);c=await l.text()}n=this.K.di(L,c),this.ql.set(t,n)}else n=e,this.ql.set(t,n);const o={id:t,createShader:()=>n,createUniforms:(c,l)=>{const u={u_resolution:[l.width,l.height]};for(const[f,[d,g]]of s){let v=g;c!=null&&(typeof c=="number"&&d===r?v=c:typeof c=="object"&&d in c&&(v=c[d]??g)),u[f]=v}return u}};this.Zl.set(t,o)}tu(t){const e=this.ql.get(t);return e&&(e.dispose(),this.ql.delete(t)),this.Zl.delete(t)}$n(t){return this.Zl.get(t)}Fs(){for(const t of this.ql.values())t.dispose();this.ql.clear(),this.Zl.clear()}Vl(){this.Jl("invert",`#version 300 es
precision highp float;uniform sampler2D u_texture;in vec2 v_uv;out vec4 fragColor;void main(){vec4 A=texture(u_texture,v_uv);fragColor=vec4(1.-A.rgb,A.a);}`,{}),this.Jl("grayscale",`#version 300 es
precision highp float;uniform sampler2D u_texture;uniform float U8;in vec2 v_uv;out vec4 fragColor;void main(){vec4 A=texture(u_texture,v_uv);float B=dot(A.rgb,vec3(0.299,0.587,0.114));vec3 C=mix(A.rgb,vec3(B),U8);fragColor=vec4(C,A.a);}`,{U8:["amount",1]}),this.Jl("sepia",`#version 300 es
precision highp float;uniform sampler2D u_texture;uniform float U8;in vec2 v_uv;out vec4 fragColor;void main(){vec4 A=texture(u_texture,v_uv);vec3 B;B.r=dot(A.rgb,vec3(0.393,0.769,0.189));B.g=dot(A.rgb,vec3(0.349,0.686,0.168));B.b=dot(A.rgb,vec3(0.272,0.534,0.131));vec3 C=mix(A.rgb,B,U8);fragColor=vec4(C,A.a);}`,{U8:["amount",1]}),this.Jl("threshold",`#version 300 es
precision highp float;uniform sampler2D u_texture;uniform float U9;in vec2 v_uv;out vec4 fragColor;void main(){vec4 A=texture(u_texture,v_uv);float B=dot(A.rgb,vec3(0.299,0.587,0.114));float C=step(U9,B);fragColor=vec4(vec3(C),A.a);}`,{U9:["threshold",.5]})}}class ee{constructor(t){a(this,"K");a(this,"ql",new Map);a(this,"V");a(this,"Xc");a(this,"yr",!1);a(this,"su");this.K=t,this.su=new te(this.K),this.V=t.di(L,bt)}async register(t,e,i={}){await this.su.Jl(t,e,i)}unregister(t){return this.su.tu(t)??!1}has(t){return this.su.$n(t)!==void 0}Ar(t,e){this.yr||(this.Xc=[this.K.$i(t,e,1,{depth:!1}),this.K.$i(t,e,1,{depth:!1})],this.yr=!0)}eu(t,e,i,s,r){this.Xc[0].width===s&&this.Xc[0].height===r||(this.Xc[0].resize(s,r),this.Xc[1].resize(s,r)),this.tl(t,e,i,s,r,this.Xc)}tl(t,e,i,s,r,n){if(i.length===0)return void this.iu(t,e,s,r);this.iu(t,n[0],s,r);let o=0;for(let c=0;c<i.length;c++){const l=i[c],u=c===i.length-1,f=o===0?1:0,d=u?e:n[f];this.ru(l,n[o],d,s,r),u||(o=f)}}ru(t,e,i,s,r){const n=this.su.$n(t.name);if(!n)return console.warn(`[textmode.js] Unknown filter: "${t.name}". Skipping.`),void this.iu(e.textures[0],i,s,r);const o=this.nu(t.name,n,s,r),c={renderer:this.K,gl:this.K.context,width:s,height:r};i.begin(),this.K.fi(o),o.O({u_texture:e.textures[0]});const l=n.createUniforms(t.params,c);o.O(l),this.K.Ai(0,0,s,r),i.end()}nu(t,e,i,s){let r=this.ql.get(t);if(!r&&e){const n={renderer:this.K,gl:this.K.context,width:i,height:s};r=e.createShader(n),this.ql.set(t,r)}return r}iu(t,e,i,s){e.begin(),this.K.fi(this.V),this.V.O({u_texture:t,u_resolution:[i,s]}),this.K.Ai(0,0,i,s),e.end()}Vr(t,e){this.Xc&&(this.Xc[0].resize(t,e),this.Xc[1].resize(t,e))}Fs(){for(const t of this.ql.values())t.dispose();this.ql.clear(),this.V.dispose(),this.su.Fs(),this.Xc&&(this.Xc[0].dispose(),this.Xc[1].dispose()),this.yr=!1}}const $e=Object.freeze(Object.defineProperty({__proto__:null,FilterRegistry:te,TextmodeFilterManager:ee},Symbol.toStringTag,{value:"Module"}));class ie{constructor(t,e){a(this,"ga");a(this,"K");a(this,"ou");a(this,"hu");a(this,"au");a(this,"cu");a(this,"lu");a(this,"uu");a(this,"fu");a(this,"du");a(this,"Wl",!1);a(this,"vu","2d");a(this,"pu",new Set);a(this,"mu",[]);a(this,"gu");a(this,"_u");this.ga=t,this.K=t.K,this.cu=this.K.di(L,Qt),this.lu=this.K.di(L,bt),this.au=new ee(this.K),this.ou=new qt(this.K,this.ga.Er.width,this.ga.Er.height),this.hu=new Jt(this.K),this.uu=new at,this.fu=new Je({onRemove:i=>this.ga.Jc.La(i),onDispose:i=>i.Fs()}),this.du=new ht(this.K,{visible:!0,opacity:1,fontSize:e.fontSize,fontSource:e.fontSource})}async Ar(){var e,i;await this.yu(this.du);const t=this.ga.Er;this.gu=this.K.$i(t.width,t.height,1),this._u=this.K.$i(t.width,t.height,1),this.au.Ar(t.width,t.height),await this.fu.initialize(s=>this.yu(s)),this.hu.Ar(((e=this.du.grid)==null?void 0:e.cols)||1,((i=this.du.grid)==null?void 0:i.rows)||1,1+this.fu.length),this.Wl=!0}Au(t,e){this.mu.push({name:t,params:e})}bu(){this.mu=[]}add(t={}){const e=new ht(this.K,t);return this.fu.isReady&&this.yu(e),this.fu.add(e),e}remove(t){this.fu.remove(t)}move(t,e){this.fu.move(t,e)}swap(t,e){this.fu.swap(t,e)}mode(t){return t?(this.vu=t,t):this.vu}rotation(t,e,i){if(t===void 0)return this.uu.rotation();this.uu.rotation(t,e,i)}translation(t,e,i){if(t===void 0)return this.uu.translation();this.uu.translation(t,e,i)}zoom(t){if(t===void 0)return this.uu.zoom();this.uu.zoom(t)}clear(){this.fu.clear()}wu(t){this.ga.Jc.Ea(),this.du.va(this.ga,this.cu,this.vu);const e=[...this.K.state.canvasBackgroundColor];this.fu.forEach(i=>i.va(this.ga,this.cu,this.vu)),this.vu==="3d"?this.xu(t,e):this.Mu(t,e)}Cu(){this.wu(this.gu);let t=this.gu.textures[0];if(this.mu.length>0){const i=this.ga.Er;this.au.eu(this.gu.textures[0],this._u,this.mu,i.width,i.height),t=this._u.textures[0],this.mu=[]}const e=this.ga.Er;this.K.ye(0,0,0,0),this.K.fi(this.lu),this.lu.O({u_texture:t}),this.K.Ai(0,0,e.width,e.height),this.ga.Jc.Da()}Mu(t,e){const i=this.ga.Er,s=this.du.grid,r=this.du.texture;if(!r)return;const n={layer:this.du,texture:r,width:s.width,height:s.height,offsetX:s.offsetX+this.du.Lc,offsetY:s.offsetY+this.du.Oc},o=this.fu.map(c=>{const l=c.grid;return{layer:c,texture:c.texture,width:l.width,height:l.height,offsetX:l.offsetX+c.Lc,offsetY:l.offsetY+c.Oc}});this.ou.wl({base:n,layers:o,targetFramebuffer:t,backgroundColor:e,canvasWidth:i.width,canvasHeight:i.height})}xu(t,e){const i=this.ga.Er,s=this.du.drawFramebuffer,r=this.du.grid;if(!s||!r)return;let n=r.cols*r.rows,o=r;for(const c of this.fu){const l=c.grid;if(l){const u=l.cols*l.rows;u>n&&(n=u,o=l)}}this.hu.Il===o.cols&&this.hu.Nl===o.rows||this.hu.Vr(o.cols,o.rows,1+this.fu.length),this.hu.wl({baseDrawFramebuffer:s,targetFramebuffer:t,backgroundColor:e,baseLayer:this.du,layers:this.fu.all,font:this.du.font,grid:o,canvasWidth:i.width,canvasHeight:i.height,options3D:{camera:this.uu}})}Vr(){var n,o,c;if(!this.Wl)return;const t=this.ga.Er;this.du.Vr(),this.fu.forEach(l=>l.Vr()),this.ou.Vr(t.width,t.height);const e=this.du.grid;let i=(e==null?void 0:e.cols)||0,s=(e==null?void 0:e.rows)||0;for(const l of this.fu){const u=l.grid;u&&(i=Math.max(i,u.cols),s=Math.max(s,u.rows))}const r=1+this.fu.length;this.hu.Vr(i,s,r),(n=this.gu)==null||n.resize(t.width,t.height),(o=this._u)==null||o.resize(t.width,t.height),(c=this.au)==null||c.Vr(t.width,t.height)}Fs(){var t,e;this.fu.dispose(),this.ga.Jc.La(this.du),this.du.Fs(),this.au.Fs(),this.cu.dispose(),this.lu.dispose(),this.ou.Fs(),this.hu.Fs(),(t=this.gu)==null||t.dispose(),(e=this._u)==null||e.dispose(),this.mu=[]}get all(){return this.fu.all}get base(){return this.du}get filters(){return this.au}get camera(){return this.uu}Fu(){const t=this.fu.all;for(let e=t.length-1;e>=0;e--){const i=t[e];if(i.kc&&i.grid)return i.grid}return this.du.grid}$u(t){this.pu.add(t)}Pu(){for(const t of this.pu)t()}async yu(t){var i;const e={renderer:this.K,canvas:this.ga.Er,filterManager:this.au,createFramebuffer:(s,r,n=1,o)=>this.K.$i(s,r,n,o)};await t.qc(e),(i=t.grid)==null||i.Br(()=>this.Pu())}}let xt=null;const ti={id:"brightness",createShader:({gl:h})=>(xt||(xt=new Y(h,$,`#version 300 es
precision highp float;in vec2 v_uv;uniform sampler2D u_image;uniform bool u_invert;uniform bool u_flipX;uniform bool u_flipY;uniform float u_charRotation;uniform bool u_charColorFixed;uniform vec4 u_charColor;uniform bool u_cellColorFixed;uniform vec4 u_cellColor;uniform vec4 u_backgroundColor;uniform int u_charCount;uniform vec3 u_charList[255];layout(location=0)out vec4 o_character;layout(location=1)out vec4 o_primaryColor;layout(location=2)out vec4 o_secondaryColor;layout(location=3)out vec4 A;float B(vec3 C){return dot(C,vec3(0.299f,0.587f,0.114f));}void main(){vec2 D=vec2(v_uv.x,1.0f-v_uv.y);vec4 E=texture(u_image,D);float F=B(E.rgb);vec2 G=vec2(0.);if(u_charCount>0){float H=float(u_charCount);float I=clamp(F*(H-1.0f),0.0f,H-1.0f);int J=int(floor(I+0.5f));vec3 K=u_charList[J];G=K.xy;}else{G=vec2(0.0f,0.0f);}vec4 L=u_charColorFixed?u_charColor:E;vec4 M=u_cellColorFixed?u_cellColor:E;if(E.a<0.01f){discard;}o_primaryColor=vec4(L.rgb,L.a);o_secondaryColor=vec4(M.rgb,M.a);A=vec4(0.);int N=int(u_invert?1:0);int O=int(u_flipX?1:0);int P=int(u_flipY?1:0);float Q=float(N|(O<<1)|(P<<2))/255.;o_character=vec4(G,Q,clamp(u_charRotation,0.0f,1.0f));}`)),xt),createUniforms:({source:h})=>h.createBaseConversionUniforms()};class se{constructor(){a(this,"Tu",new Map);a(this,"ql",new Map);this.zu()}Jl(t){this.Tu.set(t.id,t)}tu(t){const e=this.ql.get(t);return e&&(e.dispose(),this.ql.delete(t)),this.Tu.delete(t)}$n(t){return this.Tu.get(t)}Su(t){return this.Tu.has(t)}Fs(){for(const t of this.ql.values())t.dispose();this.ql.clear(),this.Tu.clear()}zu(){this.Jl(ti)}}class re{constructor(){a(this,"Ru");this.Ru=new se}register(t){this.Ru.Jl(t)}unregister(t){return this.Ru.tu(t)}has(t){return this.Ru.Su(t)}$n(t){return this.Ru.$n(t)}Fs(){this.Ru.Fs()}}const ei=Object.freeze(Object.defineProperty({__proto__:null,ConversionRegistry:se,TextmodeConversionManager:re},Symbol.toStringTag,{value:"Module"}));class ne extends function(e,...i){return i.reduce((s,r)=>r(s),e)}(class{},Ke,He,je,ke,We){constructor(e={}){super();a(this,"K");a(this,"Er");a(this,"da");a(this,"sh");a(this,"pa");a(this,"ma");a(this,"Eu");a(this,"fa");a(this,"ua");a(this,"pn");a(this,"Jc");a(this,"ku",!1);a(this,"Du",!1);a(this,"Lu",!1);a(this,"Ou",!1);a(this,"Hu",()=>{});a(this,"Bu",()=>{});a(this,"Iu");a(this,"Nu");a(this,"jr",!1);a(this,"Gu");a(this,"ju");this.Jc=new Yt(this),this.jr=e.overlay??!1,this.Er=new Dt(e),this.K=new Te(this.Er.Jr()),this.da=new zt(e.frameRate??60),this.Eu=new Vt(this,e.loadingScreen,this.Er.qr()),this.Eu.pl(()=>{this.da.Kn=0,this.Ou=!0}),this.fa=new ie(this,e);const i=()=>this.Qu();this.sh=new Ot(this.Er,i),this.pa=new Gt(this.Er,i,this.sh),this.ma=new Bt,this.pn=new re,this.Jc.Pa(e.plugins??[]),this.Eu.In(),this.Yu()}async Yu(){await this.fa.Ar(),await this.Eu.Ar();const e=this.fa.base.grid;this.fa.$u(()=>{this.sh.zo(),this.pa.zo()}),this.jr&&(this.Gu=J.Pn(this.K,this.pn,this.Er.targetCanvas,e.cols,e.rows)),this.Xu(),this.da.In(()=>this.va());try{await this.Jc.Na(),await this.Hu(),await this.Jc.ja(),this.Eu.wc()}catch(i){console.error("Error during setup:",i),this.Eu.error(i)}}Xu(){this.Iu=()=>{this.jr&&this.resizeCanvas(this.Er.targetCanvas.width,this.Er.targetCanvas.height),this.Bu()},window.addEventListener("resize",this.Iu),this.sh.wo(),this.pa.wo(),this.ma.wo(),window.addEventListener("blur",()=>{this.ma.th()}),this.jr&&(this.Nu=new ResizeObserver(()=>{this.resizeCanvas(this.Er.targetCanvas.width,this.Er.targetCanvas.height)}),this.Nu.observe(this.Er.targetCanvas))}va(){if(!this.Eu.gc&&this.Ou){this.Du=!0;try{this.da.Yn(),this.da.Zn(),this.jr&&Ft(this.K.context,this.Gu.texture,this.Er.targetCanvas),this.fa.Cu()}finally{this.Du=!1,this.ku&&!this.Lu&&this.Wu()}}}resizeCanvas(e,i){var s;this.Er.Vr(e,i),this.Eu._l(this.Er.qr()),this.Eu.Vr(),(s=this.fa)==null||s.Vr(),this.K.zi(),this.va()}destroy(){this.Lu||this.ku||(this.ku=!0,this.da.Gn(),this.Du||this.Wu())}Wu(){var e,i,s,r;this.ku=!1,this.Eu.Fs(),this.Jc.Qa(),window.removeEventListener("resize",this.Iu),(e=this.Nu)==null||e.disconnect(),this.sh.To(),this.pa.To(),this.ma.To(),(i=this.fa)==null||i.Fs(),(s=this.pn)==null||s.Fs(),this.K.Fs(),(r=this.Gu)==null||r.Fs(),this.Er.Fs(),this.Lu=!0}filter(e,i){this.fa.Au(e,i)}draw(e){this.fa.base.draw(e)}async loadFont(e){return await this.fa.base.loadFont(e),this.fa.base.font}fontSize(e){this.fa.base.fontSize(e)}inputGrid(e){return e===void 0?this.ju??"topmost":e==="topmost"?(this.ju=void 0,this.sh.zo(),void this.pa.zo()):(this.ju=e,this.sh.zo(),void this.pa.zo())}Qu(){return this.ju?this.ju:this.fa.Fu()}async setup(e){this.Hu=e}windowResized(e){this.Bu=e}get grid(){var e;return((e=this.ua)==null?void 0:e.grid)??this.fa.base.grid}get font(){var e;return((e=this.ua)==null?void 0:e.font)??this.fa.base.font}get width(){return this.Er.width}get height(){return this.Er.height}get canvas(){return this.Er.canvas}get isDisposed(){return this.Lu}get overlay(){return this.Gu}get loading(){return this.Eu}get layers(){return this.fa}get filters(){return this.fa.filters}get conversions(){return this.pn}}class ct{constructor(){}static create(t={}){return new ne(t)}static setErrorLevel(t){ft._(t)}static get version(){return"0.9.0-beta.1"}}const ii=Object.freeze(Object.defineProperty({__proto__:null,LoadingPhase:Wt,LoadingPhaseTracker:Xt,LoadingScreenManager:Vt,LoadingScreenStateMachine:Kt,LoadingScreenTransition:Ht,resolveColorInputs:kt,resolveDefaultPalette:jt,resolveTheme:Et},Symbol.toStringTag,{value:"Module"})),si=Object.freeze(Object.defineProperty({__proto__:null,TextmodeFont:rt,TextmodeImage:J,TextmodeVideo:ot},Symbol.toStringTag,{value:"Module"})),ri=Object.freeze(Object.defineProperty({__proto__:null,keyboard:Ye,mouse:Ge,touch:Xe},Symbol.toStringTag,{value:"Module"})),ni=Object.freeze(Object.defineProperty({__proto__:null,Camera3D:at,Layer3DCompositor:Jt,LayerCompositor:qt,TextmodeLayer:ht,TextmodeLayerManager:ie},Symbol.toStringTag,{value:"Module"})),oi=ct.create,hi=ct.setErrorLevel,ai=ct.version;w.TextmodeCanvas=Dt,w.TextmodeColor=C,w.TextmodeErrorLevel=O,w.TextmodeFramebuffer=B,w.TextmodeGrid=Lt,w.TextmodeShader=Y,w.Textmodifier=ne,w.conversion=ei,w.create=oi,w.filters=$e,w.input=ri,w.layering=ni,w.loadables=si,w.loading=ii,w.plugins=Qe,w.setErrorLevel=hi,w.textmode=ct,w.version=ai,Object.defineProperty(w,Symbol.toStringTag,{value:"Module"})});
